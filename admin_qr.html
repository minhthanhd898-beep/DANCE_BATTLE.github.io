<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>STREET WARS 2025 - ADMIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Permanent+Marker&family=Rubik+Glitch&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  :root { --cyan: #00f7ff; --pink: #ff0099; --lime: #ccff00; --yellow: #ffee00; --bg: #0f0f0f; }
  body { background: var(--bg) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill-opacity="0.05"><path d="M0 60 L60 0 H30 L0 30 Z" fill="white"/></svg>'); color: #eee; font-family: "Microsoft YaHei", sans-serif; margin: 0; padding: 20px; overflow-x: hidden; }
  
  /* Âü∫Á°Ä UI (ÁÆÄÂåñÁâà) */
  .container { max-width: 1300px; margin: 0 auto; background: rgba(20,20,20,0.95); border: 4px solid #fff; box-shadow: 10px 10px 0 #000; padding: 10px; }
  header { text-align: center; padding: 30px; border-bottom: 3px dashed var(--pink); }
  h1 { font-family: 'Rubik Glitch', cursive; font-size: 50px; margin: 0; text-shadow: 4px 4px 0 var(--pink); }
  .tabs { display: flex; justify-content: center; gap: 15px; padding: 20px; border-bottom: 5px solid var(--cyan); }
  .tab { font-family: 'Black Ops One'; font-size: 16px; padding: 8px 15px; cursor: pointer; background: #222; border: 2px solid #555; transform: skewX(-15deg); }
  .tab.active { background: var(--cyan); color: #000; border-color: #fff; transform: skewX(-15deg) scale(1.1); box-shadow: 0 0 15px var(--cyan); }
  .panel { display: none; padding: 30px; min-height: 600px; }
  .panel.active { display: block; animation: fadeIn 0.5s; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  
  /* ÊåâÈíÆ & ËæìÂÖ•Ê°Ü */
  .btn { font-family: 'Black Ops One'; border: none; padding: 8px 20px; margin: 5px; cursor: pointer; transform: skewX(-10deg); transition: 0.2s; }
  .btn:hover { transform: skewX(-10deg) translate(-2px,-2px); box-shadow: 4px 4px 0 #000; }
  .btn-green { background: var(--lime); color: #000; }
  .btn-blue { background: var(--cyan); color: #000; }
  .btn-pink { background: var(--pink); color: #fff; }
  input { background: transparent; border: 1px solid #555; color: #fff; padding: 5px; text-align: center; font-family: 'Black Ops One'; font-size: 18px; }
  
  /* ÂØπÊàòÂç°Áâá */
  .battle-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 30px; }
  .match-card { background: #000; border: 2px solid #fff; padding: 10px; display: flex; align-items: center; justify-content: space-between; position: relative; }
  .fighter { flex: 1; text-align: center; padding: 15px; cursor: pointer; transition: 0.3s; }
  .fighter.winner { background: var(--cyan); color: #000 !important; transform: scale(1.05); z-index: 2; box-shadow: 0 0 20px var(--cyan); }
  .fighter.loser { opacity: 0.3; filter: grayscale(1); }
  .fighter img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; margin-bottom: 5px; }
  
  /* --- üèÜ È¢ÅÂ•ñÁõõÂÖ∏Â§ßÂ±è (Ceremony Screen) --- */
  .ceremony-screen { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 9999; flex-direction: column; align-items: center; justify-content: flex-end; padding-bottom: 50px; overflow: hidden; }
  .ceremony-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 30%, #333 0%, #000 70%); opacity: 0.5; z-index: 0; }
  
  .podium { display: flex; align-items: flex-end; justify-content: center; gap: 20px; z-index: 10; width: 100%; height: 70%; }
  
  /* È¢ÜÂ•ñÂè∞Êü±Â≠ê */
  .rank-col { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; transition: 0.5s; transform: translateY(100%); animation: slideUp 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
  .rank-col.first { animation-delay: 0.5s; z-index: 10; }
  .rank-col.second { animation-delay: 0.2s; z-index: 5; }
  .rank-col.third { animation-delay: 0s; z-index: 5; }
  @keyframes slideUp { to { transform: translateY(0); } }

  .avatar-box { width: 180px; height: 180px; border: 8px solid #fff; border-radius: 50%; overflow: hidden; margin-bottom: -40px; position: relative; z-index: 20; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
  .avatar-box img { width: 100%; height: 100%; object-fit: cover; }
  .first .avatar-box { width: 260px; height: 260px; border-color: var(--yellow); box-shadow: 0 0 50px var(--yellow); }
  
  .info-box { text-align: center; background: #111; border: 3px solid #fff; padding: 50px 20px 20px 20px; width: 220px; position: relative; clip-path: polygon(0 20%, 100% 0, 100% 100%, 0% 100%); margin-top: -20px; }
  .first .info-box { background: linear-gradient(180deg, #ffd700 0%, #b8860b 100%); border-color: #fff; width: 320px; height: 350px; padding-top: 80px; }
  .second .info-box { background: linear-gradient(180deg, #c0c0c0 0%, #808080 100%); height: 280px; }
  .third .info-box { background: linear-gradient(180deg, #cd7f32 0%, #8b4513 100%); height: 240px; }

  .p-rank { font-family: 'Rubik Glitch'; font-size: 60px; color: rgba(0,0,0,0.3); position: absolute; bottom: 10px; right: 10px; line-height: 1; }
  .p-name { font-family: 'Permanent Marker'; font-size: 30px; color: #fff; text-shadow: 2px 2px 0 #000; line-height: 1.2; }
  .first .p-name { font-size: 50px; color: #000; text-shadow: none; }
  .p-id { font-family: 'Black Ops One'; font-size: 18px; color: #fff; background: #000; padding: 2px 10px; display: inline-block; margin-top: 10px; transform: rotate(-3deg); }

  .crown { position: absolute; top: -120px; left: 50%; transform: translateX(-50%) rotate(-10deg); font-size: 100px; animation: float 2s infinite ease-in-out; z-index: 30; }
  @keyframes float { 0%,100%{transform: translateX(-50%) rotate(-10deg) translateY(0);} 50%{transform: translateX(-50%) rotate(-10deg) translateY(-20px);} }

  .close-btn { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 30px; cursor: pointer; z-index: 100; opacity: 0.5; }
  .close-btn:hover { opacity: 1; }
  .ceremony-title { position: absolute; top: 50px; font-family: 'Rubik Glitch'; font-size: 80px; color: #fff; text-shadow: 0 0 20px var(--pink); z-index: 5; width: 100%; text-align: center; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>STREET WARS 2025</h1>
    <p style="font-family:'Black Ops One'; color:var(--yellow);">BATTLE MANAGEMENT SYSTEM</p>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)">ROSTER</div>
    <div class="tab" onclick="switchTab(1)">AUDITION</div>
    <div class="tab" onclick="switchTab(2)">TOP 32</div>
    <div class="tab" onclick="switchTab(3)">TOP 16</div>
    <div class="tab" onclick="switchTab(4)">TOP 8</div>
    <div class="tab" onclick="switchTab(5)">SEMI</div>
    <div class="tab" onclick="switchTab(6)">FINAL</div>
  </div>

  <!-- Èù¢Êùø 0-1 ÁúÅÁï•ÈÉ®ÂàÜ‰ª£Á†ÅÔºåÈÄªËæë‰øùÊåÅ‰∏çÂèòÔºåÈáçÁÇπÂú®‰∏ãÊñπ Battle -->
  <div class="panel active" id="panel0">
    <!-- ÁÆÄÂåñÁöÑÈÄâÊâãÁÆ°ÁêÜÁïåÈù¢ -->
    <button class="btn btn-green" onclick="syncRegistration()">SYNC</button>
    <button class="btn btn-blue" onclick="addPlayerRow()">ADD</button>
    <span style="color:#fff; margin-left:20px;">TOTAL: <span id="totalCount">0</span></span>
    <table style="width:100%; margin-top:20px;">
        <tbody id="playerListBody"></tbody>
    </table>
  </div>

  <div class="panel" id="panel1">
    <!-- ÁÆÄÂåñÁöÑÊµ∑ÈÄâÁïåÈù¢ -->
    <button class="btn btn-blue" onclick="renderScoreTable(true)">RANK</button>
    <button class="btn btn-green" onclick="finalizeAudition()">LOCK >></button>
    <table style="width:100%; margin-top:20px;">
        <thead id="scoreHeader"></thead>
        <tbody id="scoreBody"></tbody>
    </table>
  </div>

  <!-- Battle Panels -->
  <div id="battlePanels"></div>
</div>

<!-- üèÜ È¢ÅÂ•ñÁõõÂÖ∏Â§ßÂ±è -->
<div id="ceremonyScreen" class="ceremony-screen">
  <div class="close-btn" onclick="closeCeremony()">√ó</div>
  <div class="ceremony-bg"></div>
  <div class="ceremony-title">THE CHAMPIONS</div>
  <div class="podium" id="podiumContent">
    <!-- Âä®ÊÄÅÁîüÊàê -->
  </div>
</div>

<script>
  // ==================== ‚òÖ‚òÖ‚òÖ ÈÖçÁΩÆÂå∫Âüü ‚òÖ‚òÖ‚òÖ ====================
  const SB_URL = "https://htqlaedczmaezrlqmwft.supabase.co"; 
  const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0cWxhZWRjem1hZXpybHFtd2Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTQ2NzEsImV4cCI6MjA4NTkzMDY3MX0._LB75XfBc940vgnmx95ryZxWb-AZRJmuty8B1z_x08g";
  // ============================================================

  const { createClient } = supabase;
  const _supabase = (SB_URL !== "YOUR_SUPABASE_URL_HERE") ? createClient(SB_URL, SB_KEY) : null;
  const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjMzMzIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIvPjwvc3ZnPg==';

  let appData = { players: [], audition: { finished: false, results: [] }, judgeCount: 3, rounds: [] };
  const ROUND_CONFIG = [{ idx: 0, tabId: 2, n: 'TOP 32' },{ idx: 1, tabId: 3, n: 'TOP 16' },{ idx: 2, tabId: 4, n: 'TOP 8' },{ idx: 3, tabId: 5, n: 'SEMI' },{ idx: 4, tabId: 6, n: 'FINAL' }];

  // ÂàùÂßãÂåñ
  window.onload = async () => {
    await loadFromCloud();
    createBattlePanelsHtml(); 
    renderPlayerManager(); renderScoreTable(false); refreshBattlePanels();
    if (_supabase) _supabase.channel('reg').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'registrations' }, () => syncRegistration()).subscribe();
  };

  /* --- È¢ÅÂ•ñÁõõÂÖ∏ÈÄªËæë (Ê†∏ÂøÉÊñ∞Â¢û) --- */
  function showCeremony() {
      const finalRound = appData.rounds[4]; // ÂÜ≥Ëµõ
      const semiRound = appData.rounds[3];  // ÂçäÂÜ≥Ëµõ (ÊâæÂ≠£ÂÜõ)
      if(!finalRound || !finalRound.matches[0].winnerId) { alert("ÂÜ≥ËµõÂ∞öÊú™ÁªìÊùüÔºÅ(Finish Final First)"); return; }

      const m = finalRound.matches[0];
      const champion = m.winnerId === m.p1.id ? m.p1 : m.p2;
      const second = m.winnerId === m.p1.id ? m.p2 : m.p1;
      
      // ÂØªÊâæÂ≠£ÂÜõ (ÂçäÂÜ≥ËµõËæìÊéâÁöÑ‰∏§‰∫∫)
      let thirds = [];
      if(semiRound) {
          semiRound.matches.forEach(sm => {
              const loser = sm.winnerId === sm.p1.id ? sm.p2 : sm.p1;
              if(loser) thirds.push(loser);
          });
      }

      const p = document.getElementById('podiumContent');
      p.innerHTML = '';

      // 2. ‰∫öÂÜõ (Â∑¶)
      p.innerHTML += createRankHTML(second, 'second', '2ND');
      
      // 1. ÂÜ†ÂÜõ (‰∏≠)
      p.innerHTML += createRankHTML(champion, 'first', 'WINNER');

      // 3. Â≠£ÂÜõ (Âè≥ÔºåÂèØËÉΩÊúâ2‰∫∫Âπ∂Âàó)
      thirds.forEach(t => {
          p.innerHTML += createRankHTML(t, 'third', '3RD');
      });

      document.getElementById('ceremonyScreen').style.display = 'flex';
      
      // üéâ Êí≠ÊîæÂ∫ÜÁ•ùÁâπÊïà
      fireConfetti();
  }

  function createRankHTML(player, rankClass, rankTitle) {
      const av = player.avatar || DEFAULT_AVATAR;
      const crown = rankClass === 'first' ? '<div class="crown">üëë</div>' : '';
      return `
        <div class="rank-col ${rankClass}">
            ${crown}
            <div class="avatar-box"><img src="${av}"></div>
            <div class="info-box">
                <div class="p-name">${player.name}</div>
                <div class="p-id">#${player.id}</div>
                <div class="p-rank">${rankTitle}</div>
            </div>
        </div>
      `;
  }

  function fireConfetti() {
      var duration = 5 * 1000;
      var animationEnd = Date.now() + duration;
      var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 10000 };

      var interval = setInterval(function() {
        var timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) return clearInterval(interval);
        var particleCount = 50 * (timeLeft / duration);
        // ÈöèÊú∫‰ΩçÁΩÆÂñ∑Â∞Ñ
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
      }, 250);
  }
  function randomInRange(min, max) { return Math.random() * (max - min) + min; }
  function closeCeremony() { document.getElementById('ceremonyScreen').style.display = 'none'; }

  /* --- ÂéüÊúâÈÄªËæë‰øùÁïô --- */
  async function loadFromCloud() { if(!_supabase)return; const {data}=await _supabase.from('game_state').select('data').eq('id',1).single(); if(data) appData=data.data; if(!appData.audition.results) appData.audition.results=[]; }
  async function saveToCloud() { if(!_supabase)return; await _supabase.from('game_state').upsert({id:1,data:appData}); }
  async function syncRegistration() {
      if(!_supabase) { alert("Config First!"); return; }
      const { data } = await _supabase.from('registrations').select('*').eq('processed', false);
      if(data && data.length) {
          data.forEach(r => { if(!appData.players.some(p=>p.id===r.player_id)) appData.players.push({id:r.player_id,name:r.player_name,avatar:r.avatar}); });
          await _supabase.from('registrations').update({processed:true}).in('id', data.map(d=>d.id));
          saveToCloud(); refreshAllUI();
      }
  }
  function refreshAllUI() { renderPlayerManager(); if(!appData.audition.finished) syncAuditionList(); renderScoreTable(false); refreshBattlePanels(); }
  function switchTab(n) { document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===n)); document.querySelectorAll('.panel').forEach((p,i)=>p.classList.toggle('active',i===n)); }
  function addPlayerRow() { appData.players.push({id:'',name:'',avatar:''}); renderPlayerManager(); saveToCloud(); }
  function renderPlayerManager() { document.getElementById('playerListBody').innerHTML = appData.players.map((p,i)=>`<tr><td><img src="${p.avatar||DEFAULT_AVATAR}" style="width:30px;height:30px;border-radius:50%"></td><td><input oninput="appData.players[${i}].id=this.value;saveToCloud()" value="${p.id}"></td><td><input oninput="appData.players[${i}].name=this.value;saveToCloud()" value="${p.name}"></td><td>X</td></tr>`).join(''); }
  function syncAuditionList() { if(appData.audition.finished)return; const map={}; appData.audition.results.forEach(r=>map[r.id]=r.scores); appData.audition.results=appData.players.map(p=>({id:p.id,name:p.name,avatar:p.avatar,scores:map[p.id]||[],avg:0,rank:0})); }
  function renderScoreTable(sort) { 
      let l=[...appData.audition.results];
      if(sort||appData.audition.finished){ l.forEach(p=>{let s=0,c=0;p.scores.forEach(v=>{if(v){s+=parseFloat(v);c++}});p.avg=c?s/c:0;}); l.sort((a,b)=>b.avg-a.avg); l.forEach((p,i)=>p.rank=i+1); if(appData.audition.finished)appData.audition.results=l;}
      document.getElementById('scoreBody').innerHTML = l.map(p=>`<tr ${p.rank<=32?'style="background:#222"':''}><td>${p.rank}</td><td>${p.id}</td><td>${p.name}</td><td>${Number(p.avg).toFixed(2)}</td></tr>`).join('');
  }
  function finalizeAudition() { if(!confirm('Lock?'))return; appData.audition.finished=true; const seed=[[1,32],[16,17],[9,24],[8,25],[5,28],[12,21],[13,20],[4,29],[3,30],[14,19],[11,22],[6,27],[7,26],[10,23],[15,18],[2,31]]; appData.rounds[0]={matches:seed.map((p,i)=>({id:i+1,p1:appData.audition.results[p[0]-1],p2:appData.audition.results[p[1]-1],winnerId:null}))}; saveToCloud(); refreshAllUI(); switchTab(2); }
  
  function createBattlePanelsHtml() {
      document.getElementById('battlePanels').innerHTML = ROUND_CONFIG.map(cfg=>`<div id="panel${cfg.tabId}" class="panel"><h3>${cfg.n}</h3><button class="btn btn-green" id="btnNext${cfg.idx}" onclick="nextRound(${cfg.idx})">NEXT</button>${cfg.idx===4?'<button class="btn btn-pink" onclick="showCeremony()" style="margin-left:20px;">üèÜ SHOW CEREMONY</button>':''}<div class="battle-container" id="matchesContainer${cfg.idx}"></div></div>`).join('');
  }
  function refreshBattlePanels() {
      appData.rounds.forEach((rnd,idx)=>{
          if(!rnd)return;
          const c=document.getElementById(`matchesContainer${idx}`); c.innerHTML='';
          rnd.matches.forEach(m=>{
              const av1=m.p1.avatar||DEFAULT_AVATAR, av2=m.p2.avatar||DEFAULT_AVATAR;
              const w1=m.winnerId===m.p1.id?'winner':'', w2=m.winnerId===m.p2.id?'winner':'';
              c.innerHTML+=`<div class="match-card"><div class="fighter ${w1}" onclick="setWin(${idx},${m.id-1},'${m.p1.id}')"><img src="${av1}"><br>${m.p1.name}</div><div style="font-family:'Rubik Glitch';font-size:30px;color:var(--pink)">VS</div><div class="fighter ${w2}" onclick="setWin(${idx},${m.id-1},'${m.p2.id}')"><img src="${av2}"><br>${m.p2.name}</div></div>`;
          });
      });
  }
  function setWin(r,m,w){ appData.rounds[r].matches[m].winnerId=w; saveToCloud(); refreshBattlePanels(); }
  function nextRound(c){ if(!confirm('Next?'))return; const cur=appData.rounds[c].matches, next=[]; for(let i=0;i<cur.length;i+=2) next.push({id:i/2+1,p1:getId(cur[i]),p2:getId(cur[i+1]),winnerId:null}); appData.rounds[c+1]={matches:next}; saveToCloud(); refreshAllUI(); switchTab(c+3); }
  function getId(m){return m.winnerId===m.p1.id?m.p1:m.p2;}
  function clearAll(){ if(confirm('RESET?')){ appData={players:[],audition:{finished:false,results:[]},judgeCount:3,rounds:[]}; saveToCloud(); refreshAllUI(); } }
</script>
</body>
</html>

