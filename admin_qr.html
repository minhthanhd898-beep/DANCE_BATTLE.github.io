<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>STREET WARS 2025 - ç®¡ç†ç«¯ ADMIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- å½©å¸¦ç‰¹æ•ˆåº“ -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<!-- å­—ä½“ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Permanent+Marker&family=Rubik+Glitch&display=swap" rel="stylesheet">
<!-- QRCode (æŠ¥åäºŒç»´ç ) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
:root {
  --cyan:  #00f7ff;
  --pink:  #ff0099;
  --lime:  #ccff00;
  --yellow:#ffeb3b;
  --bg:    #0f0f0f;
  --font-cn: "Microsoft YaHei", sans-serif;
  --font-stencil: "Black Ops One", cursive;
  --font-graffiti: "Permanent Marker", cursive;
  --font-glitch: "Rubik Glitch", cursive;
}

body {
  background: var(--bg);
  background-image:
    linear-gradient(335deg, rgba(255,255,255,0.05) 23px, transparent 23px),
    linear-gradient(155deg, rgba(255,255,255,0.05) 23px, transparent 23px);
  background-size: 58px 58px;
  margin: 0;
  padding: 20px;
  font-family: var(--font-cn);
  color: #eee;
  overflow-x: hidden;
}

.container {
  max-width: 1300px;
  margin: 0 auto;
  background: rgba(20,20,20,0.95);
  border: 4px solid #fff;
  box-shadow: 10px 10px 0 #000;
  padding: 10px;
  clip-path: polygon(0% 5px, 5px 0%, 99% 0%, 100% 5px, 100% 100%, 0 100%);
}

header {
  text-align: center;
  padding: 30px;
  border-bottom: 3px dashed var(--pink);
}
h1 {
  margin: 0;
  font-family: var(--font-glitch);
  font-size: 50px;
  color: #fff;
  text-shadow: 4px 4px 0 var(--pink), -2px -2px 0 var(--cyan);
  transform: rotate(-2deg);
}
header p {
  margin: 5px 0 0;
  font-family: var(--font-stencil);
  color: var(--yellow);
  letter-spacing: 2px;
}

/* Tabs */
.tabs {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 12px;
  padding: 15px 10px 0;
  background: #000;
  border-bottom: 4px solid var(--cyan);
}
.tab {
  font-family: var(--font-cn);
  font-weight: bold;
  font-size: 14px;
  padding: 8px 16px;
  background: #222;
  color: #aaa;
  border: 2px solid #555;
  transform: skewX(-15deg);
  cursor: pointer;
  transition: 0.2s;
  box-shadow: 3px 3px 0 #000;
}
.tab.active {
  background: var(--cyan);
  color: #000;
  border-color: #fff;
  box-shadow: 0 0 15px var(--cyan);
  transform: skewX(-15deg) scale(1.05);
}

/* Panels */
.panel {
  display: none;
  padding: 25px;
  background:
    radial-gradient(circle at top right, rgba(0,247,255,0.12), transparent 40%),
    radial-gradient(circle at bottom left, rgba(255,0,153,0.12), transparent 40%),
    #111;
  min-height: 600px;
}
.panel.active { display: block; }

/* Buttons & Inputs */
.btn {
  font-family: var(--font-cn);
  font-weight: bold;
  border: none;
  padding: 8px 18px;
  margin: 4px;
  cursor: pointer;
  transform: skewX(-10deg);
  box-shadow: 3px 3px 0 #000;
  transition: 0.15s;
}
.btn:hover {
  transform: skewX(-10deg) translate(-2px,-2px);
  box-shadow: 5px 5px 0 #000;
}
.btn-blue  { background: var(--cyan);  color: #000; }
.btn-pink  { background: var(--pink);  color: #fff; }
.btn-green { background: var(--lime);  color: #000; }
.btn-dark  { background: #333;        color: #fff; }
.btn-small { padding: 4px 10px; font-size: 12px;}

input[type="text"], input[type="number"] {
  background: transparent;
  border: 1px solid #444;
  color: #fff;
  padding: 4px 6px;
  font-family: var(--font-stencil);
  font-size: 16px;
  text-align: center;
}
input:focus {
  outline: none;
  border-color: var(--pink);
}

/* Status bar */
.status-bar {
  background: #000;
  border: 2px solid #444;
  padding: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* search */
.search-box {
  background: transparent;
  border: none;
  border-bottom: 2px solid var(--cyan);
  color: var(--cyan);
  padding: 4px 10px;
  font-family: var(--font-graffiti);
  font-size: 16px;
  width: 200px;
}

/* table */
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 6px;
  margin-top: 15px;
}
th {
  color: #888;
  font-size: 14px;
  border-bottom: 2px solid #333;
  padding: 6px;
}
td {
  background: #111;
  padding: 6px;
  border-top: 1px solid #222;
  border-bottom: 1px solid #222;
  vertical-align: middle;
}

/* avatars */
.avatar-sm {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid #fff;
  object-fit: cover;
}

/* audition */
.rank-num {
  font-family: var(--font-glitch);
  font-size: 20px;
  color: #777;
}
.top-rank td {
  border-top: 1px dashed var(--cyan);
  border-bottom: 1px dashed var(--cyan);
}
.top-rank .rank-num {
  color: var(--cyan);
  text-shadow: 0 0 2px rgba(0,247,255,0.7);
}

/* battle cards */
.battle-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
  gap: 20px;
  margin-top: 20px;
}
.match-card {
  position: relative;
  background:#000;
  border:2px solid #fff;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:8px;
  box-shadow:5px 5px 0 #000;
}
.fighter {
  flex:1;
  text-align:center;
  padding:12px 5px;
  cursor:pointer;
  transition:0.2s;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.fighter img{
  width:60px;
  height:60px;
  border-radius:50%;
  border:2px solid #fff;
  object-fit:cover;
  margin-bottom:4px;
}
.fighter-name{font-family:var(--font-cn);font-size:16px;}
.fighter-id{font-family:var(--font-stencil);font-size:12px;color:#aaa;}
.fighter.winner{
  background:var(--cyan);
  color:#000;
  box-shadow:0 0 15px var(--cyan);
}
.fighter.loser{opacity:0.35;filter:grayscale(1);}
.vs-tag{
  font-family:var(--font-glitch);
  font-size:32px;
  color:var(--pink);
  margin:0 8px;
}
.match-tools {
  position:absolute;
  top:4px;
  right:4px;
}

/* VS Screen */
#vsScreen {
  display:none;  /* é‡è¦ï¼šé»˜è®¤éšè— */
  position:fixed;
  inset:0;
  z-index:9998;
  background:#000;
  display:flex;
  flex-direction:row;
  align-items:center;
  justify-content:center;
}
.vs-side{
  flex:1;
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  position:relative;
}
.vs-side.left {
  background:linear-gradient(135deg,#111,#000);
  border-right:5px solid var(--cyan);
}
.vs-side.right{
  background:linear-gradient(225deg,#111,#000);
  border-left:5px solid var(--pink);
}
.vs-avatar-big{
  width:260px;
  height:260px;
  border-radius:50%;
  border:10px solid #fff;
  object-fit:cover;
  box-shadow:0 0 40px rgba(0,0,0,0.8);
  margin-bottom:20px;
}
.vs-name-big{
  font-family:var(--font-glitch);
  font-size:60px;
  color:#fff;
  text-shadow:3px 3px 0 #000;
}
.vs-id-big{
  font-family:var(--font-stencil);
  font-size:32px;
  color:var(--yellow);
  background:#000;
  padding:4px 16px;
  margin-top:10px;
}
.vs-center-logo{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  font-family:var(--font-glitch);
  font-size:140px;
  color:#fff;
  text-shadow:0 0 30px var(--pink), 5px 5px 0 #000;
  pointer-events:none;
}
.vs-close-btn{
  position:absolute;
  top:20px;
  right:20px;
  font-size:26px;
  color:#fff;
  cursor:pointer;
  opacity:0.6;
}

/* é¢å¥–å…¸ç¤¼å…¨å± */
.ceremony-screen {
  display:none;  /* é»˜è®¤éšè— */
  position:fixed;
  inset:0;
  z-index:9999;
  background:#000;
  font-family:var(--font-cn);
  flex-direction:column;
  align-items:center;
  justify-content:flex-end;
  padding-bottom:40px;
  overflow:hidden;
}
.ceremony-bg{
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at 50% 20%, rgba(255,255,255,0.08) 0, transparent 50%),
    radial-gradient(circle at 0% 100%, rgba(0,247,255,0.15) 0, transparent 50%),
    radial-gradient(circle at 100% 100%, rgba(255,0,153,0.15) 0, transparent 50%),
    #000;
  opacity:0.9;
}
.ceremony-title{
  position:absolute;
  top:40px;
  width:100%;
  text-align:center;
  font-family:var(--font-glitch);
  font-size:72px;
  color:#fff;
  text-shadow:0 0 25px var(--pink),4px 4px 0 #000;
  letter-spacing:4px;
  z-index:5;
}
.ceremony-close{
  position:absolute;
  top:20px;
  right:25px;
  font-size:30px;
  color:#fff;
  cursor:pointer;
  z-index:30;
  opacity:0.5;
}
.ceremony-close:hover{opacity:1;}
.podium{
  position:relative;
  width:100%;
  height:70%;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  gap:40px;
  z-index:10;
}
.rank-col{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-end;
  transform:translateY(100%);
  animation:podium-rise 1s cubic-bezier(0.18,0.89,0.32,1.28) forwards;
}
.rank-col.second{animation-delay:0.2s;}
.rank-col.third{animation-delay:0.4s;}
.rank-col.first{animation-delay:0.6s;z-index:20;}
@keyframes podium-rise{to{transform:translateY(0);}}
.avatar-box{
  width:180px;
  height:180px;
  border-radius:50%;
  border:8px solid #fff;
  overflow:hidden;
  margin-bottom:-40px;
  box-shadow:0 10px 40px rgba(0,0,0,0.8);
  background:#000;
  position:relative;
  z-index:20;
}
.avatar-box img{width:100%;height:100%;object-fit:cover;}
.rank-col.first .avatar-box{
  width:260px;
  height:260px;
  border-color:var(--yellow);
  box-shadow:0 0 60px rgba(255,235,59,0.9);
}
.info-box{
  text-align:center;
  background:#111;
  border:3px solid #fff;
  padding:50px 20px 20px;
  width:230px;
  position:relative;
  clip-path:polygon(0 25%,100% 0,100% 100%,0 100%);
}
.rank-col.first .info-box{
  width:320px;
  height:280px;
  padding-top:80px;
  background:linear-gradient(180deg,#ffd700 0%,#b8860b 100%);
}
.rank-col.second .info-box{
  height:220px;
  background:linear-gradient(180deg,#c0c0c0 0%,#808080 100%);
}
.rank-col.third .info-box{
  height:200px;
  background:linear-gradient(180deg,#cd7f32 0%,#8b4513 100%);
}
.p-rank{
  position:absolute;
  bottom:10px;
  right:12px;
  font-family:var(--font-glitch);
  font-size:42px;
  color:rgba(0,0,0,0.25);
}
.p-name{
  font-family:var(--font-graffiti);
  font-size:30px;
  color:#fff;
  text-shadow:2px 2px 0 #000;
}
.rank-col.first .p-name{
  font-size:46px;
  color:#000;
  text-shadow:none;
}
.p-id{
  font-family:var(--font-stencil);
  font-size:20px;
  color:#fff;
  background:#000;
  display:inline-block;
  padding:3px 12px;
  margin-top:12px;
  transform:rotate(-3deg);
}
.crown{
  position:absolute;
  top:-110px;
  left:50%;
  transform:translateX(-50%) rotate(-10deg);
  font-size:90px;
  text-shadow:0 0 25px rgba(255,235,59,0.9);
  animation:crown-float 2s infinite ease-in-out;
}
@keyframes crown-float{
  0%,100%{transform:translateX(-50%) rotate(-10deg) translateY(0);}
  50%{transform:translateX(-50%) rotate(-10deg) translateY(-18px);}
}

/* QR å¼¹çª— */
.qr-modal{
  display:none;  /* é»˜è®¤éšè— */
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.9);
  z-index:9990;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
#qrcode{background:#fff;padding:20px;border:4px solid var(--lime);}
.qr-close{margin-top:20px;color:#fff;cursor:pointer;}
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>STREET WARS 2025</h1>
    <p>è¡—èˆå·…å³°äº‰éœ¸èµ› Â· ç®¡ç†ç«¯</p>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)">é€‰æ‰‹åº“</div>
    <div class="tab" onclick="switchTab(1)">æµ·é€‰</div>
    <div class="tab" onclick="switchTab(2)">32 å¼º</div>
    <div class="tab" onclick="switchTab(3)">16 å¼º</div>
    <div class="tab" onclick="switchTab(4)">8 å¼º</div>
    <div class="tab" onclick="switchTab(5)">åŠå†³èµ›</div>
    <div class="tab" onclick="switchTab(6)">å†³èµ›</div>
  </div>

  <!-- é€‰æ‰‹åº“ -->
  <div class="panel active" id="panel0">
    <div class="status-bar">
      <div>
        <input id="searchPlayer" class="search-box" placeholder="æœç´¢å§“åæˆ–å·ç ..." oninput="renderPlayerManager()">
        <span style="margin-left:10px;">æ€»äººæ•°ï¼š<b id="totalCount">0</b></span>
      </div>
      <div>
        <button class="btn btn-green" onclick="syncRegistration()">æ¥æ”¶æŠ¥å</button>
        <button class="btn btn-blue" onclick="showQR()">æŠ¥åäºŒç»´ç </button>
        <button class="btn btn-pink" onclick="addPlayer()">æ·»åŠ é€‰æ‰‹</button>
        <button class="btn btn-dark" onclick="resetAll()">é‡ç½®æ¯”èµ›(ä¿ç•™é€‰æ‰‹)</button>
      </div>
    </div>
    <table>
      <thead><tr><th>å¤´åƒ</th><th>å·ç </th><th>å§“å</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="playerListBody"></tbody>
    </table>
  </div>

  <!-- æµ·é€‰ -->
  <div class="panel" id="panel1">
    <div class="status-bar">
      <div>
        è£åˆ¤æ•°é‡ï¼š
        <input type="number" id="judgeCount" value="3" min="1" max="5" style="width:60px" onchange="renderScoreTable(true)">
      </div>
      <div>
        <button class="btn btn-blue" onclick="renderScoreTable(true)">åˆ·æ–°æ’å</button>
        <button class="btn btn-pink" onclick="exportAuditionPDF()">å¯¼å‡ºæµ·é€‰æˆç»©PDF</button>
        <button class="btn btn-green" onclick="finalizeAudition()">é”å®šå¹¶ç”Ÿæˆ32å¼º</button>
      </div>
    </div>
    <p style="color:#888; font-size:12px;">æç¤ºï¼šä¸è¶³ 32 äººä¼šè‡ªåŠ¨å¡«å…… BYE è½®ç©ºä½ï¼Œä¸€æ ·å¯ä»¥ç»§ç»­æ¯”èµ›ã€‚</p>
    <table>
      <thead><tr id="scoreHeader"></tr></thead>
      <tbody id="scoreBody"></tbody>
    </table>
  </div>

  <!-- å¯¹æˆ˜è½®æ¬¡ -->
  <div id="battlePanels"></div>
</div>

<!-- VS å¤§å± -->
<div id="vsScreen">
  <div class="vs-side left">
    <img id="vsAvatar1" class="vs-avatar-big" src="">
    <div id="vsName1" class="vs-name-big">PLAYER 1</div>
    <div id="vsId1" class="vs-id-big">#001</div>
  </div>
  <div class="vs-center-logo">VS</div>
  <div class="vs-side right">
    <img id="vsAvatar2" class="vs-avatar-big" src="">
    <div id="vsName2" class="vs-name-big">PLAYER 2</div>
    <div id="vsId2" class="vs-id-big">#002</div>
  </div>
  <div class="vs-close-btn" onclick="document.getElementById('vsScreen').style.display='none'">Ã—</div>
</div>

<!-- ğŸ† é¢å¥–å¤§å± -->
<div id="ceremonyScreen" class="ceremony-screen">
  <div class="ceremony-bg"></div>
  <div class="ceremony-title">THE CHAMPIONS</div>
  <div class="ceremony-close" onclick="closeCeremony()">Ã—</div>
  <div class="podium" id="podiumContent"></div>
</div>

<!-- æŠ¥åäºŒç»´ç å¼¹çª— -->
<div id="qrModal" class="qr-modal">
  <div id="qrcode"></div>
  <div class="qr-close" onclick="document.getElementById('qrModal').style.display='none'">å…³é—­</div>
</div>

<script>
/* ========== Supabase é…ç½® ========== */
const SB_URL = "https://htqlaedczmaezrlqmwft.supabase.co";          // ä¾‹å¦‚ï¼šhttps://xxxx.supabase.co
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0cWxhZWRjem1hZXpybHFtd2Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTQ2NzEsImV4cCI6MjA4NTkzMDY3MX0._LB75XfBc940vgnmx95ryZxWb-AZRJmuty8B1z_x08g";     // anon å…¬é’¥

const { createClient } = supabase;
const sb = (SB_URL.startsWith('http')) ? createClient(SB_URL, SB_KEY) : null;

const DEFAULT_AVATAR =
  'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjMzMzIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIvPjwvc3ZnPg==';

let appData = {
  players: [],
  audition: { finished:false, results:[] },
  judgeCount: 3,
  rounds: []
};

const ROUND_CONFIG = [
  { idx:0, tabId:2,  name:'32 å¼ºå¯¹å†³' },
  { idx:1, tabId:3,  name:'16 å¼ºå¯¹å†³' },
  { idx:2, tabId:4,  name:'8 å¼ºå¯¹å†³' },
  { idx:3, tabId:5,  name:'åŠå†³èµ› 4â†’2' },
  { idx:4, tabId:6,  name:'å†³èµ› 2â†’1' }
];

window.onload = async () => {
  if(sb) await loadFromCloud();
  ensureStructures();
  createBattlePanels();
  renderPlayerManager();
  renderScoreTable(false);
  refreshBattlePanels();

  if(sb){
    sb.channel('reg-ch')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'registrations'}, ()=>syncRegistration())
      .subscribe();
  }
};

/* ç»“æ„æ£€æŸ¥ */
function ensureStructures(){
  if(!appData.players) appData.players=[];
  if(!appData.audition) appData.audition={finished:false,results:[]};
  if(!appData.audition.results) appData.audition.results=[];
  if(!Array.isArray(appData.rounds)) appData.rounds=[];
}

/* ============= Supabase åŒæ­¥ ============= */
async function loadFromCloud(){
  try{
    const {data,error} = await sb.from('game_state').select('data').eq('id',1).maybeSingle();
    if(error){console.warn('loadFromCloud error',error);return;}
    if(data && data.data){ appData=data.data; }
  }catch(e){console.error(e);}
}
async function saveToCloud(){
  try{
    if(!sb) return;
    await sb.from('game_state').upsert({id:1,data:appData});
  }catch(e){console.error(e);}
}
async function syncRegistration(){
  if(!sb){ alert("å°šæœªé…ç½® Supabase"); return; }
  try{
    const {data,error} = await sb
      .from('registrations')
      .select('*')
      .eq('processed',false);
    if(error){console.error(error);return;}
    if(!data || !data.length){ alert("æš‚æ— æ–°çš„æŠ¥åæ•°æ®"); return; }

    let added=0;
    data.forEach(row=>{
      if(!appData.players.some(p=>p.id===row.player_id)){
        appData.players.push({
          id: row.player_id,
          name: row.player_name,
          avatar: row.avatar || DEFAULT_AVATAR
        });
        added++;
      }
    });

    const ids = data.map(r=>r.id);
    await sb.from('registrations').update({processed:true}).in('id',ids);

    if(added>0){
      alert(`æˆåŠŸæ¥æ”¶ ${added} ä½æ–°é€‰æ‰‹`);
      ensureStructures();
      renderPlayerManager();
      if(!appData.audition.finished) syncAuditionList();
      renderScoreTable(false);
      await saveToCloud();
    }
  }catch(e){console.error(e);}
}

/* ============= Tab ============= */
function switchTab(i){
  document.querySelectorAll('.tab').forEach((el,idx)=>el.classList.toggle('active',idx===i));
  document.querySelectorAll('.panel').forEach((el,idx)=>el.classList.toggle('active',idx===i));
}

/* ============= é€‰æ‰‹åº“ ============= */
function addPlayer(){
  appData.players.push({id:'',name:'',avatar:DEFAULT_AVATAR});
  renderPlayerManager();
  saveToCloud();
}
function renderPlayerManager(){
  const tb = document.getElementById('playerListBody');
  const term = document.getElementById('searchPlayer').value?.toLowerCase() || '';
  tb.innerHTML = '';
  appData.players.forEach((p,i)=>{
    if(term && !p.id.toLowerCase().includes(term) && !p.name.toLowerCase().includes(term)) return;
    const av = p.avatar || DEFAULT_AVATAR;
    tb.innerHTML += `
      <tr>
        <td><img src="${av}" class="avatar-sm"></td>
        <td><input value="${p.id}" oninput="appData.players[${i}].id=this.value; saveToCloud();"></td>
        <td><input style="text-align:left;" value="${p.name}" oninput="appData.players[${i}].name=this.value; saveToCloud();"></td>
        <td><button class="btn btn-small btn-dark" onclick="removePlayer(${i})">åˆ </button></td>
      </tr>`;
  });
  document.getElementById('totalCount').innerText = appData.players.length;
}
function removePlayer(i){
  if(!confirm('ç¡®å®šåˆ é™¤è¯¥é€‰æ‰‹ï¼Ÿ'))return;
  appData.players.splice(i,1);
  ensureStructures();
  renderPlayerManager();
  if(!appData.audition.finished) syncAuditionList();
  renderScoreTable(false);
  saveToCloud();
}

// âœ… é‡ç½®æ¯”èµ›ï¼ˆä¿ç•™é€‰æ‰‹ï¼‰
function resetAll(){
  if(!confirm('ç¡®å®šé‡ç½®æ‰€æœ‰æ¯”èµ›æ•°æ®ï¼ˆä¿ç•™é€‰æ‰‹åå•ï¼‰ï¼Ÿ'))return;
  appData.audition = {finished:false,results:[]};
  appData.rounds = [];
  appData.judgeCount = 3;
  ensureStructures();
  renderScoreTable(false);
  refreshBattlePanels();
  saveToCloud();
}

/* ============= æµ·é€‰ ============= */
function syncAuditionList(){
  if(appData.audition.finished) return;
  const scoreMap = {};
  appData.audition.results.forEach(r=>scoreMap[r.id]=r.scores||[]);
  appData.audition.results = appData.players.map(p=>({
    id:p.id,
    name:p.name,
    avatar:p.avatar||DEFAULT_AVATAR,
    scores: scoreMap[p.id] || [],
    avg:0,
    rank:0
  }));
}
function renderScoreTable(sort){
  ensureStructures();
  const judges = parseInt(document.getElementById('judgeCount').value) || 3;
  appData.judgeCount = judges;

  const th = document.getElementById('scoreHeader');
  let headHtml = `<th>å¤´åƒ</th><th>æ’å</th><th>å·ç </th><th>å§“å</th><th>å¹³å‡åˆ†</th>`;
  for(let i=0;i<judges;i++) headHtml+=`<th>è£åˆ¤${i+1}</th>`;
  th.innerHTML = headHtml;

  appData.audition.results.forEach(p=>{
    let sum=0,c=0;
    for(let i=0;i<judges;i++){
      const v=parseFloat(p.scores?.[i]);
      if(!isNaN(v)){sum+=v;c++;}
    }
    p.avg=c>0?sum/c:0;
  });

  let list=[...appData.audition.results];
  if(sort || appData.audition.finished){
    list.sort((a,b)=>b.avg-a.avg || a.id.localeCompare(b.id));
    list.forEach((p,i)=>p.rank=i+1);
    if(appData.audition.finished) appData.audition.results=list;
  }

  const tb=document.getElementById('scoreBody');
  tb.innerHTML='';
  list.forEach(p=>{
    const isTop32 = p.rank>0 && p.rank<=32 && p.id!=='BYE';
    const cls = isTop32?'class="top-rank"':'';
    const av = p.avatar || DEFAULT_AVATAR;
    let row = `<tr ${cls}>
      <td><img src="${av}" class="avatar-sm"></td>
      <td class="rank-num">${p.rank||'-'}</td>
      <td>${p.id}</td>
      <td style="text-align:left;">${p.name}</td>
      <td style="color:${isTop32?'var(--cyan)':'var(--pink)'};font-weight:bold;">${p.avg.toFixed(2)}</td>`;
    for(let j=0;j<judges;j++){
      const val = p.scores?.[j] ?? '';
      const dis = appData.audition.finished?'disabled':'';
      row += `<td><input type="number" step="0.1" value="${val}" ${dis}
                 oninput="onScoreInput('${p.id}',${j},this.value)"></td>`;
    }
    row+='</tr>';
    tb.innerHTML+=row;
  });
}
function onScoreInput(pid,idx,val){
  const p = appData.audition.results.find(x=>x.id===pid);
  if(!p)return;
  if(!Array.isArray(p.scores))p.scores=[];
  p.scores[idx]=val;
  saveToCloud();
}

/* âœ… æµ·é€‰æˆç»© PDFï¼ˆä¸­æ–‡ï¼‰ */
function exportAuditionPDF(){
  ensureStructures();
  let judges = appData.judgeCount || parseInt(document.getElementById('judgeCount').value) || 3;

  let list = [...appData.audition.results];
  if(!list.length){
    syncAuditionList();
    list = [...appData.audition.results];
  }

  list.forEach(p=>{
    let sum=0,c=0;
    for(let i=0;i<judges;i++){
      const v=parseFloat(p.scores?.[i]);
      if(!isNaN(v)){sum+=v;c++;}
    }
    p.avg=c>0?sum/c:0;
  });
  list.sort((a,b)=>b.avg-a.avg || a.id.localeCompare(b.id));
  list.forEach((p,i)=>p.rank=i+1);

  let rows='';
  list.forEach(p=>{
    const isPromoted = (p.id!=='BYE' && p.rank<=32);
    const style = isPromoted ? 'background-color:#e0f7fa;font-weight:bold;' : '';
    const statusText = isPromoted ? 'æ™‹çº§' : 'æœªæ™‹çº§';
    let scoreCells='';
    for(let j=0;j<judges;j++){
      const v = p.scores?.[j] ?? '';
      scoreCells += `<td style="border:1px solid #000;padding:4px;">${v!==''?v:'-'}</td>`;
    }
    rows += `<tr style="${style}">
      <td style="border:1px solid #000;padding:4px;">${p.rank}</td>
      <td style="border:1px solid #000;padding:4px;">${p.id}</td>
      <td style="border:1px solid #000;padding:4px;text-align:left;">${p.name}</td>
      ${scoreCells}
      <td style="border:1px solid #000;padding:4px;">${p.avg.toFixed(2)}</td>
      <td style="border:1px solid #000;padding:4px;">${statusText}</td>
    </tr>`;
  });

  const html = `
  <html><head><meta charset="UTF-8">
  <title>æµ·é€‰æˆç»©å•</title></head>
  <body style="font-family:'Microsoft YaHei',Arial,Helvetica,sans-serif;">
    <h2 style="text-align:center;margin-bottom:5px;">è¡—èˆå·…å³°äº‰éœ¸èµ› æµ·é€‰æˆç»©å•</h2>
    <p style="text-align:center;margin-top:0;font-size:12px;">æœ¬è¡¨ä¸ºæ‰€æœ‰å‚èµ›é€‰æ‰‹çš„æµ·é€‰æˆç»©åŠæ™‹çº§æƒ…å†µ</p>
    <table style="border-collapse:collapse;width:100%;font-size:12px;text-align:center;">
      <tr style="background:#ddd;">
        <th style="border:1px solid #000;padding:4px;">æ’å</th>
        <th style="border:1px solid #000;padding:4px;">å‚èµ›å·ç </th>
        <th style="border:1px solid #000;padding:4px;">é€‰æ‰‹å§“å</th>
        ${Array.from({length:judges}).map((_,i)=>`<th style="border:1px solid #000;padding:4px;">è£åˆ¤${i+1}åˆ†</th>`).join('')}
        <th style="border:1px solid #000;padding:4px;">å¹³å‡åˆ†</th>
        <th style="border:1px solid #000;padding:4px;">çŠ¶æ€</th>
      </tr>
      ${rows}
    </table>
    <p style="font-size:11px;margin-top:10px;">
      è¯´æ˜ï¼šå‰ 32 åï¼ˆæµ…è“åº•åŠ ç²—ï¼‰ä¸ºæ™‹çº§é€‰æ‰‹ï¼›â€œæ™‹çº§â€è¡¨ç¤ºè¿›å…¥ 32 å¼ºï¼Œâ€œæœªæ™‹çº§â€è¡¨ç¤ºæ­¢æ­¥æµ·é€‰ã€‚
    </p>
  </body></html>`;

  const w = window.open('', '_blank');
  w.document.open(); w.document.write(html); w.document.close();
  setTimeout(()=>w.print(),500);
}

/* é”å®šæµ·é€‰å¹¶ç”Ÿæˆ32å¼ºï¼ˆå« BYEï¼‰ */
function finalizeAudition(){
  if(appData.audition.finished){
    alert('æµ·é€‰å·²é”å®šã€‚');
    return;
  }
  if(!appData.audition.results.length){
    syncAuditionList();
  }
  renderScoreTable(true);
  
  let list = [...appData.audition.results].sort((a,b)=>b.avg-a.avg||a.id.localeCompare(b.id));
  let top32 = list.slice(0,32);
  if(top32.length < 32){
    const need = 32 - top32.length;
    if(!confirm(`å½“å‰é€‰æ‰‹ ${top32.length} äººï¼Œè‡ªåŠ¨å¡«å…… ${need} ä¸ª BYE è½®ç©ºä½ç»§ç»­ï¼Ÿ`)) return;
    for(let i=0;i<need;i++){
      top32.push({
        id:'BYE',
        name:'BYE (è½®ç©º)',
        avatar:DEFAULT_AVATAR,
        isBye:true,
        scores:[],
        avg:0,
        rank: top32.length+1
      });
    }
  }

  appData.audition.finished = true;
  appData.audition.results = top32;

  const seed = [
    [1,32],[16,17],[9,24],[8,25],
    [5,28],[12,21],[13,20],[4,29],
    [3,30],[14,19],[11,22],[6,27],
    [7,26],[10,23],[15,18],[2,31]
  ];

  appData.rounds = [];
  const matches = seed.map((pair,i)=>({
    id:i+1,
    p1: top32[pair[0]-1],
    p2: top32[pair[1]-1],
    winnerId: null
  }));
  appData.rounds[0] = { matches };

  appData.rounds[0].matches.forEach(m=>{
    if(m.p1.isBye && !m.p2.isBye) m.winnerId=m.p2.id;
    if(m.p2.isBye && !m.p1.isBye) m.winnerId=m.p1.id;
  });

  saveToCloud();
  refreshBattlePanels();
  switchTab(2);
}

/* ============= å¯¹æˆ˜è½®æ¬¡ ============= */
function createBattlePanels(){
  const container = document.getElementById('battlePanels');
  container.innerHTML = '';
  ROUND_CONFIG.forEach(cfg=>{
    const extraBtn = (cfg.idx===4)
      ? `<button class="btn btn-pink" onclick="showCeremony()">ğŸ† é¢å¥–å…¸ç¤¼</button>`
      : '';
    container.innerHTML += `
      <div class="panel" id="panel${cfg.tabId}">
        <div class="status-bar">
          <div>${cfg.name}</div>
          <div>
            <button class="btn btn-blue" onclick="refreshBattlePanels()">åˆ·æ–°å¯¹é˜µ</button>
            <button class="btn btn-green" id="nextBtn${cfg.idx}" onclick="nextRound(${cfg.idx})">ç”Ÿæˆä¸‹ä¸€è½®</button>
            ${extraBtn}
          </div>
        </div>
        <div class="battle-container" id="battleContainer${cfg.idx}"></div>
      </div>
    `;
  });
}
function refreshBattlePanels(){
  ensureStructures();
  ROUND_CONFIG.forEach(cfg=>{
    const idx = cfg.idx;
    const round = appData.rounds[idx];
    const box = document.getElementById('battleContainer'+idx);
    const btn = document.getElementById('nextBtn'+idx);
    if(!box) return;
    box.innerHTML = '';
    if(!round || !round.matches){ 
      if(btn) { btn.disabled = true; btn.textContent = 'ç­‰å¾…ä¸Šä¸€è½®'; }
      return;
    }
    const allDone = round.matches.every(m=>m.winnerId);
    if(btn){
      btn.disabled = (idx===4) || !allDone;
      btn.textContent = idx===4 ? 'å·²æ˜¯æœ€åä¸€è½®' : (allDone?'ç”Ÿæˆä¸‹ä¸€è½®':'ç­‰å¾…èƒœè€…');
    }
    round.matches.forEach((m,i)=>{
      const p1 = m.p1 || {id:'?',name:'?',avatar:DEFAULT_AVATAR};
      const p2 = m.p2 || {id:'?',name:'?',avatar:DEFAULT_AVATAR};
      const av1 = p1.avatar || DEFAULT_AVATAR;
      const av2 = p2.avatar || DEFAULT_AVATAR;
      const w1 = m.winnerId===p1.id;
      const w2 = m.winnerId===p2.id;
      const locked = !!appData.rounds[idx+1];
      const click1 = locked ? '' : `onclick="setWinner(${idx},${i},'${p1.id}')"`;
      const click2 = locked ? '' : `onclick="setWinner(${idx},${i},'${p2.id}')"`;

      box.innerHTML += `
      <div class="match-card">
        <div class="match-tools">
          <button class="btn btn-small btn-dark" onclick="openVSScreen('${escapeHtml(p1.name)}','${p1.id}','${av1}','${escapeHtml(p2.name)}','${p2.id}','${av2}')">VSå±å¹•</button>
        </div>
        <div class="fighter ${w1?'winner':(m.winnerId?'loser':'')}" ${click1}>
          <img src="${av1}">
          <div class="fighter-name">${p1.name}</div>
          <div class="fighter-id">#${p1.id}</div>
        </div>
        <div class="vs-tag">VS</div>
        <div class="fighter ${w2?'winner':(m.winnerId?'loser':'')}" ${click2}>
          <img src="${av2}">
          <div class="fighter-name">${p2.name}</div>
          <div class="fighter-id">#${p2.id}</div>
        </div>
      </div>`;
    });
  });
}
function setWinner(roundIdx,matchIdx,pid){
  const round = appData.rounds[roundIdx];
  if(!round)return;
  const m = round.matches[matchIdx];
  if(!m)return;
  m.winnerId = (m.winnerId===pid?null:pid);
  saveToCloud();
  refreshBattlePanels();
}
function nextRound(roundIdx){
  if(roundIdx===4) return;
  const round = appData.rounds[roundIdx];
  if(!round || !round.matches) return;
  if(!round.matches.every(m=>m.winnerId)){
    alert('æœ¬è½®å°šæœ‰å¯¹å†³æœªé€‰å‡ºèƒœè€…ã€‚');
    return;
  }
  if(!confirm('æ ¹æ®æœ¬è½®ç»“æœç”Ÿæˆä¸‹ä¸€è½®å¯¹é˜µï¼Ÿ'))return;
  const nextMatches=[];
  for(let i=0;i<round.matches.length;i+=2){
    const m1 = round.matches[i];
    const m2 = round.matches[i+1];
    const w1 = winnerObject(m1);
    const w2 = winnerObject(m2);
    nextMatches.push({id:nextMatches.length+1,p1:w1,p2:w2,winnerId:null});
  }
  appData.rounds[roundIdx+1]={matches:nextMatches};
  saveToCloud();
  refreshBattlePanels();
  switchTab(roundIdx+3);
}
function winnerObject(m){
  if(!m || !m.winnerId) return m?.p1||{id:'?',name:'?',avatar:DEFAULT_AVATAR};
  return m.winnerId===m.p1.id?m.p1:m.p2;
}

/* VS å±å¹• */
function openVSScreen(n1,id1,av1,n2,id2,av2){
  document.getElementById('vsName1').innerText = n1;
  document.getElementById('vsId1').innerText   = '#'+id1;
  document.getElementById('vsAvatar1').src     = av1||DEFAULT_AVATAR;

  document.getElementById('vsName2').innerText = n2;
  document.getElementById('vsId2').innerText   = '#'+id2;
  document.getElementById('vsAvatar2').src     = av2||DEFAULT_AVATAR;

  document.getElementById('vsScreen').style.display='flex';
}

/* é¢å¥–å…¸ç¤¼ */
function createCeremonyBlock(player, rankClass, label){
  if(!player) return '';
  const av = player.avatar||DEFAULT_AVATAR;
  const crown = rankClass==='first' ? '<div class="crown">ğŸ‘‘</div>' : '';
  return `
    <div class="rank-col ${rankClass}">
      ${crown}
      <div class="avatar-box"><img src="${av}"></div>
      <div class="info-box">
        <div class="p-name">${escapeHtml(player.name||'UNKNOWN')}</div>
        <div class="p-id">#${player.id||''}</div>
        <div class="p-rank">${label}</div>
      </div>
    </div>`;
}
function showCeremony(){
  const finalRound = appData.rounds[4];
  if(!finalRound || !finalRound.matches || !finalRound.matches[0]){
    alert('è¿˜æ²¡æœ‰å†³èµ›æ•°æ®ã€‚');
    return;
  }
  const fm = finalRound.matches[0];
  if(!fm.winnerId){
    alert('è¯·å…ˆåœ¨å†³èµ›ä¸­é€‰æ‹©èƒœè€…ã€‚');
    return;
  }
  const champion = fm.winnerId===fm.p1.id?fm.p1:fm.p2;
  const runner   = fm.winnerId===fm.p1.id?fm.p2:fm.p1;

  const semiRound = appData.rounds[3];
  const thirds=[];
  if(semiRound && semiRound.matches){
    semiRound.matches.forEach(m=>{
      if(!m.winnerId)return;
      const loser = m.winnerId===m.p1.id?m.p2:m.p1;
      if(loser && loser.id!=='BYE') thirds.push(loser);
    });
  }

  const podium = document.getElementById('podiumContent');
  podium.innerHTML = '';
  if(runner) podium.innerHTML += createCeremonyBlock(runner,'second','2ND');
  podium.innerHTML += createCeremonyBlock(champion,'first','WINNER');
  if(thirds.length){
    thirds.forEach(t=> podium.innerHTML += createCeremonyBlock(t,'third','3RD'));
  }

  document.getElementById('ceremonyScreen').style.display='flex';
  fireConfetti();
}
function closeCeremony(){
  document.getElementById('ceremonyScreen').style.display='none';
}
function fireConfetti(){
  if(typeof confetti==='undefined')return;
  const duration = 5000;
  const end = Date.now()+duration;
  const defaults = {startVelocity:40, spread:360, ticks:80, zIndex:10000};
  const interval=setInterval(()=>{
    const timeLeft=end-Date.now();
    if(timeLeft<=0){clearInterval(interval);return;}
    const count = 80*(timeLeft/duration);
    confetti(Object.assign({},defaults,{particleCount:count,origin:{x:Math.random()*0.3,y:Math.random()*0.3}}));
    confetti(Object.assign({},defaults,{particleCount:count,origin:{x:0.7+Math.random()*0.3,y:Math.random()*0.3}}));
  },250);
}

/* æŠ¥åäºŒç»´ç  */
function showQR(){
  const defaultUrl = window.location.href.replace('admin_qr.html','register.html');
  const url = prompt('è¯·è¾“å…¥æŠ¥åé¡µ(register.html)çš„å…¬ç½‘åœ°å€ï¼š',defaultUrl);
  if(!url)return;
  const box=document.getElementById('qrcode');
  box.innerHTML='';
  new QRCode(box,{text:url,width:256,height:256});
  document.getElementById('qrModal').style.display='flex';
}

/* å·¥å…· */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
</script>
</body>
</html>
