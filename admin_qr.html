<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>STREET WARS 2025 - ADMIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- ä¾èµ–åº“ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Permanent+Marker&family=Rubik+Glitch&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  /* --- æ ·å¼è¡¨ (ä¿æŒå˜»å“ˆé£æ ¼) --- */
  :root { --cyan: #00f7ff; --pink: #ff0099; --lime: #ccff00; --yellow: #ffee00; --bg: #0f0f0f; }
  body { background: var(--bg) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill-opacity="0.05"><path d="M0 60 L60 0 H30 L0 30 Z" fill="white"/></svg>'); color: #eee; font-family: "Microsoft YaHei", sans-serif; margin: 0; padding: 20px; overflow-x: hidden; }
  
  .container { max-width: 1300px; margin: 0 auto; background: rgba(20,20,20,0.95); border: 4px solid #fff; box-shadow: 10px 10px 0 #000; padding: 10px; min-height: 800px; }
  header { text-align: center; padding: 30px; border-bottom: 3px dashed var(--pink); }
  h1 { font-family: 'Rubik Glitch', cursive; font-size: 50px; margin: 0; text-shadow: 4px 4px 0 var(--pink); }
  
  .tabs { display: flex; justify-content: center; gap: 15px; padding: 20px; border-bottom: 5px solid var(--cyan); }
  .tab { font-family: 'Black Ops One'; font-size: 16px; padding: 8px 15px; cursor: pointer; background: #222; border: 2px solid #555; transform: skewX(-15deg); transition:0.3s; }
  .tab:hover { background: #444; color: #fff; }
  .tab.active { background: var(--cyan); color: #000; border-color: #fff; transform: skewX(-15deg) scale(1.1); box-shadow: 0 0 15px var(--cyan); }
  
  .panel { display: none; padding: 30px; animation: fadeIn 0.5s; }
  .panel.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  
  .btn { font-family: 'Black Ops One'; border: none; padding: 8px 20px; margin: 5px; cursor: pointer; transform: skewX(-10deg); transition: 0.2s; }
  .btn:hover { transform: skewX(-10deg) translate(-2px,-2px); box-shadow: 4px 4px 0 #000; }
  .btn-green { background: var(--lime); color: #000; }
  .btn-blue { background: var(--cyan); color: #000; }
  .btn-pink { background: var(--pink); color: #fff; }
  .btn-dark { background: #333; color: #fff; }
  .btn-small { padding: 4px 10px; font-size: 12px; }
  
  input { background: transparent; border: 1px solid #555; color: #fff; padding: 5px; text-align: center; font-family: 'Black Ops One'; font-size: 18px; }
  .status-bar { background: #000; border: 2px solid #444; padding: 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom:20px; }
  
  table { width: 100%; border-collapse: separate; border-spacing: 0 6px; }
  th { color: #888; font-size: 14px; border-bottom: 2px solid #333; padding: 6px; }
  td { background: #111; padding: 6px; border-top: 1px solid #222; border-bottom: 1px solid #222; vertical-align: middle; text-align: center; }
  .avatar-sm { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
  .top-rank td { border-top: 1px dashed var(--cyan); border-bottom: 1px dashed var(--cyan); background: rgba(0, 247, 255, 0.05); }
  .rank-num { font-family: 'Rubik Glitch'; font-size: 20px; color: #777; }
  .top-rank .rank-num { color: var(--cyan); text-shadow: 0 0 2px rgba(0,247,255,0.7); }

  .battle-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 20px; margin-top: 20px; }
  .match-card { position: relative; background:#000; border:2px solid #fff; display:flex; align-items:center; justify-content:space-between; padding:10px; box-shadow:5px 5px 0 #000; }
  .match-tools { position:absolute; top:5px; right:5px; z-index:10; }
  .fighter { flex:1; text-align:center; padding:10px; cursor:pointer; transition:0.2s; display:flex; flex-direction:column; align-items:center; border: 1px solid transparent; }
  .fighter:hover { border-color:#555; }
  .fighter img { width:60px; height:60px; border-radius:50%; border:2px solid #fff; object-fit:cover; margin-bottom:5px; }
  .fighter.winner { background:var(--cyan); color:#000 !important; box-shadow:0 0 15px var(--cyan); transform: scale(1.05); z-index:5; }
  .fighter.loser { opacity:0.3; filter:grayscale(1); }
  .vs-tag { font-family:'Rubik Glitch'; font-size:32px; color:var(--pink); margin:0 10px; }

  /* å¼¹çª—é»˜è®¤éšè— */
  #vsScreen, #ceremonyScreen, #qrModal { display: none; position: fixed; inset: 0; background: #000; z-index: 9999; }
  
  #vsScreen { flex-direction: row; align-items: center; }
  .vs-side { flex:1; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; }
  .vs-side.left { background:linear-gradient(135deg,#111,#000); border-right:5px solid var(--cyan); }
  .vs-side.right { background:linear-gradient(225deg,#111,#000); border-left:5px solid var(--pink); }
  .vs-avatar-big { width:300px; height:300px; border-radius:50%; border:10px solid #fff; object-fit:cover; margin-bottom:20px; }
  .vs-name-big { font-family:'Rubik Glitch'; font-size:60px; color:#fff; text-shadow:3px 3px 0 #000; }
  .vs-id-big { font-family:'Black Ops One'; font-size:32px; color:var(--yellow); background:#000; padding:4px 16px; margin-top:10px; }
  .vs-center-logo { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-family:'Rubik Glitch'; font-size:140px; color:#fff; text-shadow:0 0 30px var(--pink); pointer-events:none; }
  .close-btn { position:absolute; top:20px; right:20px; font-size:30px; color:#fff; cursor:pointer; opacity:0.6; z-index:10000; }

  #ceremonyScreen { flex-direction:column; align-items:center; justify-content:flex-end; padding-bottom:40px; }
  .ceremony-bg { position:absolute; inset:0; background: radial-gradient(circle at 50% 20%, rgba(255,255,255,0.1) 0, #000 60%); z-index:-1; }
  .ceremony-title { position:absolute; top:40px; font-family:'Rubik Glitch'; font-size:72px; color:#fff; text-shadow:0 0 25px var(--pink); }
  .podium { display:flex; align-items:flex-end; gap:40px; z-index:10; }
  .rank-col { display:flex; flex-direction:column; align-items:center; }
  .avatar-box { width:180px; height:180px; border-radius:50%; border:8px solid #fff; overflow:hidden; margin-bottom:-40px; z-index:20; background:#000; }
  .avatar-box img { width:100%; height:100%; object-fit:cover; }
  .rank-col.first .avatar-box { width:260px; height:260px; border-color:var(--yellow); box-shadow:0 0 50px var(--yellow); }
  .info-box { text-align:center; background:#111; border:3px solid #fff; padding:50px 20px 20px; width:220px; margin-top:-10px; clip-path:polygon(0 20%,100% 0,100% 100%,0 100%); }
  .rank-col.first .info-box { width:300px; padding-top:80px; background:linear-gradient(180deg,#ffd700,#b8860b); }
  .rank-col.second .info-box { background:linear-gradient(180deg,#c0c0c0,#808080); }
  .rank-col.third .info-box { background:linear-gradient(180deg,#cd7f32,#8b4513); }
  .crown { position:absolute; top:-100px; font-size:80px; animation:bounce 2s infinite; }
  @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-20px)} }

  #qrModal { flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.95); }
  #qrcode { background:#fff; padding:20px; border:4px solid var(--lime); }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>STREET WARS 2025</h1>
    <p style="font-family:'Black Ops One'; color:var(--yellow);">BATTLE MANAGEMENT SYSTEM</p>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)">é€‰æ‰‹åº“ (ROSTER)</div>
    <div class="tab" onclick="switchTab(1)">æµ·é€‰ (AUDITION)</div>
    <div class="tab" onclick="switchTab(2)">32å¼º</div>
    <div class="tab" onclick="switchTab(3)">16å¼º</div>
    <div class="tab" onclick="switchTab(4)">8å¼º</div>
    <div class="tab" onclick="switchTab(5)">åŠå†³èµ›</div>
    <div class="tab" onclick="switchTab(6)">å†³èµ›</div>
  </div>

  <!-- é€‰æ‰‹åº“ -->
  <div class="panel active" id="panel0">
    <div class="status-bar">
      <div>
        <input id="searchPlayer" class="search-box" style="background:transparent;border:none;border-bottom:2px solid var(--cyan);color:var(--cyan);width:200px;" placeholder="æœç´¢å§“åæˆ–å·ç ..." oninput="renderPlayerManager()">
        <span style="margin-left:10px;">æ€»äººæ•°: <b id="totalCount">0</b></span>
      </div>
      <div>
        <button class="btn btn-green" onclick="syncRegistration()">æ¥æ”¶æŠ¥å</button>
        <button class="btn btn-blue" onclick="showQR()">æŠ¥åäºŒç»´ç </button>
        <button class="btn btn-pink" onclick="addPlayer()">æ·»åŠ é€‰æ‰‹</button>
        <button class="btn btn-dark" onclick="resetGameOnly()">é‡ç½®æ¯”èµ›</button>
      </div>
    </div>
    <table>
      <thead><tr><th>å¤´åƒ</th><th>å·ç </th><th>å§“å</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="playerListBody"></tbody>
    </table>
  </div>

  <!-- æµ·é€‰ -->
  <div class="panel" id="panel1">
    <div class="status-bar">
      <div>
        è£åˆ¤æ•°ï¼š<input type="number" id="judgeCount" value="3" min="1" max="5" style="width:60px" onchange="renderScoreTable(true)">
      </div>
      <div>
        <button class="btn btn-blue" onclick="renderScoreTable(true)">åˆ·æ–°æ’å</button>
        <button class="btn btn-pink" onclick="exportAuditionPDF()">å¯¼å‡ºæˆç»©å•(PDF)</button>
        <button class="btn btn-green" onclick="finalizeAudition()">é”å®šå¹¶ç”Ÿæˆ 32 å¼º</button>
      </div>
    </div>
    <p style="color:#666; font-size:12px;">* å‰32åæ™‹çº§ï¼Œä¸è¶³32äººè‡ªåŠ¨è¡¥å…… BYEã€‚</p>
    <table>
      <thead><tr id="scoreHeader"></tr></thead>
      <tbody id="scoreBody"></tbody>
    </table>
  </div>

  <!-- å¯¹æˆ˜é¢æ¿å®¹å™¨ -->
  <div id="battlePanels"></div>
</div>

<!-- å¼¹çª—ç»„ä»¶ -->
<div id="vsScreen">
  <div class="vs-side left"><img id="vsAvatar1" class="vs-avatar-big"><div id="vsName1" class="vs-name-big"></div><div id="vsId1" class="vs-id-big"></div></div>
  <div class="vs-center-logo">VS</div>
  <div class="vs-side right"><img id="vsAvatar2" class="vs-avatar-big"><div id="vsName2" class="vs-name-big"></div><div id="vsId2" class="vs-id-big"></div></div>
  <div class="close-btn" onclick="document.getElementById('vsScreen').style.display='none'">Ã—</div>
</div>

<div id="ceremonyScreen">
  <div class="ceremony-bg"></div>
  <div class="ceremony-title">THE CHAMPIONS</div>
  <div class="close-btn" onclick="document.getElementById('ceremonyScreen').style.display='none'">Ã—</div>
  <div class="podium" id="podiumContent"></div>
</div>

<div id="qrModal">
  <div id="qrcode"></div>
  <p style="color:#fff; margin-top:20px;">SCAN TO REGISTER</p>
  <div class="close-btn" onclick="document.getElementById('qrModal').style.display='none'">å…³é—­</div>
</div>

<script>
// ========== â˜…â˜…â˜… è¯·æ›¿æ¢æ‚¨çš„ KEY â˜…â˜…â˜… ==========
const SB_URL = "https://htqlaedczmaezrlqmwft.supabase.co";          
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0cWxhZWRjem1hZXpybHFtd2Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTQ2NzEsImV4cCI6MjA4NTkzMDY3MX0._LB75XfBc940vgnmx95ryZxWb-AZRJmuty8B1z_x08g";     
// ===============================================

const { createClient } = supabase;
const sb = (SB_URL.startsWith('http')) ? createClient(SB_URL, SB_KEY) : null;
const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjMzMzIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIvPjwvc3ZnPg==';

let appData = {
  players: [],
  audition: { finished:false, results:[] },
  judgeCount: 3,
  rounds: []   
};

const ROUND_CONFIG = [
  { idx:0, tabId:2,  name:'32 å¼º (TOP 32)' }, { idx:1, tabId:3,  name:'16 å¼º (TOP 16)' },
  { idx:2, tabId:4,  name:'8 å¼º (TOP 8)' }, { idx:3, tabId:5,  name:'åŠå†³èµ› (SEMI)' },
  { idx:4, tabId:6,  name:'å†³èµ› (FINAL)' }
];

window.onload = async () => {
  if(sb) await loadFromCloud();
  ensureStructures();
  createBattlePanels();
  renderPlayerManager();
  renderScoreTable(false);
  refreshBattlePanels();
  if(sb){
    sb.channel('reg-ch').on('postgres_changes',{event:'INSERT',schema:'public',table:'registrations'}, ()=>syncRegistration()).subscribe();
  }
};

function ensureStructures(){
  if(!appData.players) appData.players=[];
  if(!appData.audition) appData.audition={finished:false,results:[]};
  if(!Array.isArray(appData.audition.results)) appData.audition.results=[];
  if(!Array.isArray(appData.rounds)) appData.rounds=[];
}

/* ============= Supabase Sync ============= */
async function loadFromCloud(){
  try{
    const {data} = await sb.from('game_state').select('data').eq('id',1).maybeSingle();
    if(data && data.data) appData = data.data;
  }catch(e){console.error(e);}
}
async function saveToCloud(){
  if(!sb) return;
  await sb.from('game_state').upsert({id:1,data:appData});
}
async function syncRegistration(){
  if(!sb){ alert("æœªé…ç½® Supabase"); return; }
  const {data} = await sb.from('registrations').select('*').eq('processed',false);
  if(data && data.length){
    data.forEach(row=>{
      if(!appData.players.some(p=>p.id===row.player_id)){
        appData.players.push({ id: row.player_id, name: row.player_name, avatar: row.avatar || DEFAULT_AVATAR });
      }
    });
    await sb.from('registrations').update({processed:true}).in('id',data.map(d=>d.id));
    alert(`æˆåŠŸæ¥æ”¶ ${data.length} ä½æ–°é€‰æ‰‹`);
    refreshUI();
    saveToCloud();
  } else alert("æš‚æ— æ–°æŠ¥å");
}
function refreshUI(){ 
    renderPlayerManager(); 
    if(!appData.audition.finished) { syncAuditionList(); renderScoreTable(false); }
}

/* ============= Players ============= */
function addPlayer(){ 
    appData.players.push({id:'',name:'',avatar:DEFAULT_AVATAR}); 
    renderPlayerManager(); 
    if(!appData.audition.finished) { syncAuditionList(); renderScoreTable(false); }
    saveToCloud(); 
}
function renderPlayerManager(){
  const term = document.getElementById('searchPlayer').value.toLowerCase();
  const tb = document.getElementById('playerListBody'); tb.innerHTML='';
  appData.players.forEach((p,i)=>{
    if(term && !p.id.toLowerCase().includes(term) && !p.name.toLowerCase().includes(term)) return;
    tb.innerHTML += `<tr><td><img src="${p.avatar||DEFAULT_AVATAR}" class="avatar-sm"></td>
    <td><input value="${p.id}" oninput="updatePlayerInfo(${i}, 'id', this.value)"></td>
    <td><input style="text-align:left;" value="${p.name}" oninput="updatePlayerInfo(${i}, 'name', this.value)"></td>
    <td><button class="btn-small btn-dark" onclick="removePlayer(${i})">åˆ </button></td></tr>`;
  });
  document.getElementById('totalCount').innerText = appData.players.length;
}
function updatePlayerInfo(idx, field, val) {
    appData.players[idx][field] = val;
    if(!appData.audition.finished) { syncAuditionList(); renderScoreTable(false); }
    saveToCloud();
}
function removePlayer(i){ 
    if(confirm('åˆ ?')) { appData.players.splice(i,1); refreshUI(); saveToCloud(); } 
}
function resetGameOnly(){
  if(confirm("ã€é‡ç½®æ¯”èµ›ã€‘ä¿ç•™é€‰æ‰‹ï¼Œæ¸…ç©ºæ¯”èµ›ï¼Ÿ")){
    appData.audition = { finished:false, results:[] };
    appData.rounds = [];
    refreshUI(); saveToCloud();
  }
}

/* ============= Audition ============= */
function syncAuditionList(){
  if(appData.audition.finished) return;
  const scoreMap = {};
  appData.audition.results.forEach(r => scoreMap[r.id] = r.scores || []);
  appData.audition.results = appData.players.map(p => ({
    id: p.id,
    name: p.name,
    avatar: p.avatar||DEFAULT_AVATAR,
    scores: scoreMap[p.id] || [],
    avg: 0,
    rank: 0
  }));
}
function renderScoreTable(sort){
  ensureStructures();
  const judges = parseInt(document.getElementById('judgeCount').value) || 3;
  appData.judgeCount = judges;
  document.getElementById('scoreHeader').innerHTML = `<th>å¤´åƒ</th><th>æ’å</th><th>å·ç </th><th>å§“å</th><th>å¹³å‡åˆ†</th>` + Array(judges).fill(0).map((_,i)=>`<th>J${i+1}</th>`).join('');
  
  appData.audition.results.forEach(p=>{
    let sum=0, c=0; 
    for(let i=0;i<judges;i++){ 
        let v=parseFloat(p.scores?.[i]); 
        if(!isNaN(v)){ sum+=v; c++; }
    }
    p.avg = c>0 ? sum/c : 0;
  });

  if(sort||appData.audition.finished){
    appData.audition.results.sort((a,b)=>b.avg-a.avg || a.id.localeCompare(b.id));
    appData.audition.results.forEach((p,i)=>p.rank=i+1);
  }
  
  const tb = document.getElementById('scoreBody'); tb.innerHTML='';
  appData.audition.results.forEach((p)=>{
    const isTop32 = p.rank>0 && p.rank<=32;
    tb.innerHTML += `<tr ${isTop32?'class="top-rank"':''}><td><img src="${p.avatar||DEFAULT_AVATAR}" class="avatar-sm"></td><td class="rank-num">${p.rank||'-'}</td><td>${p.id}</td><td style="text-align:left;">${p.name}</td><td style="color:${isTop32?'var(--cyan)':'var(--pink)'};font-weight:bold;">${p.avg.toFixed(2)}</td>${Array(judges).fill(0).map((_,j)=>`<td><input type="number" step="0.1" value="${p.scores?.[j]??''}" ${appData.audition.finished?'disabled':''} oninput="onScoreInput('${p.id}',${j},this.value)"></td>`).join('')}</tr>`;
  });
}
function onScoreInput(pid,idx,val){ 
    const p=appData.audition.results.find(x=>x.id===pid); 
    if(p){ if(!p.scores)p.scores=[]; p.scores[idx]=val; saveToCloud(); } 
}

// æ ¸å¿ƒä¿®å¤ï¼šä¸è¶³32äººè‡ªåŠ¨è¡¥ä½ BYE
function finalizeAudition(){
  if(appData.audition.finished){ alert('å·²é”å®š'); return; }
  renderScoreTable(true); // å…ˆæ’åº
  
  let top32 = appData.audition.results.slice(0,32);
  const currentCount = top32.length;
  
  // è¡¥ä½é€»è¾‘
  if(currentCount < 32){
    const need = 32 - currentCount;
    if(!confirm(`å½“å‰ä»… ${currentCount} äººï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å¡«å…… ${need} ä¸ª 'BYE' (è½®ç©º) ä»¥å‡‘é½ 32 å¼ºã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`)) return;
    
    for(let i=0; i<need; i++){
        top32.push({
            id: 'BYE', 
            name: 'BYE', 
            avatar: DEFAULT_AVATAR, 
            isBye: true, 
            scores: [], 
            avg: 0, 
            rank: 999 
        });
    }
  } else {
      if(!confirm("ç¡®å®šé”å®šæµ·é€‰åˆ†æ•°å¹¶ç”Ÿæˆ 32 å¼ºå¯¹é˜µï¼Ÿ")) return;
  }

  appData.audition.finished = true;
  appData.audition.results = top32;

  // 1vs32, 2vs31...
  const seed = [
    [1,32],[16,17],[9,24],[8,25],[5,28],[12,21],[13,20],[4,29],
    [3,30],[14,19],[11,22],[6,27],[7,26],[10,23],[15,18],[2,31]
  ];

  appData.rounds = []; 
  // ç”Ÿæˆç¬¬ä¸€è½®
  const matches = seed.map((pair,i)=>({
    id:i+1,
    p1: top32[pair[0]-1],
    p2: top32[pair[1]-1],
    winnerId: null
  }));
  appData.rounds[0] = { matches };

  // è‡ªåŠ¨è®© BYE çš„å¯¹æ‰‹è·èƒœ
  appData.rounds[0].matches.forEach(m=>{
    if(m.p1.isBye && !m.p2.isBye) m.winnerId=m.p2.id;
    if(m.p2.isBye && !m.p1.isBye) m.winnerId=m.p1.id;
  });

  saveToCloud();
  refreshBattlePanels();
  switchTab(2);
}

// å¯¼å‡º PDF
function exportAuditionPDF() {
    const judges = appData.judgeCount;
    let list = [...appData.audition.results].sort((a,b)=>b.avg-a.avg || a.id.localeCompare(b.id));
    let rows = list.map((p, i) => {
        const isPromoted = (i+1) <= 32;
        const bg = isPromoted ? 'background-color: #d1fae5; font-weight: bold;' : ''; 
        const status = isPromoted ? 'âœ… PROMOTED' : '';
        const scores = Array(judges).fill(0).map((_,j) => `<td style="border:1px solid #ccc; padding:5px;">${p.scores[j] || '-'}</td>`).join('');
        return `<tr style="${bg}"><td style="border:1px solid #ccc; padding:5px;">${i+1}</td><td style="border:1px solid #ccc; padding:5px;">${p.id}</td><td style="border:1px solid #ccc; padding:5px; text-align:left;">${p.name}</td>${scores}<td style="border:1px solid #ccc; padding:5px;">${Number(p.avg).toFixed(2)}</td><td style="border:1px solid #ccc; padding:5px; color:${isPromoted?'green':'#999'}">${status}</td></tr>`;
    }).join('');
    const html = `<html><head><title>AUDITION REPORT</title></head><body style="font-family: sans-serif; padding: 20px;"><h1 style="text-align:center;">STREET WARS 2025 - AUDITION RANKING</h1><table style="width:100%; border-collapse: collapse; text-align: center; font-size: 12px;"><thead><tr style="background:#f0f0f0;"><th style="border:1px solid #ccc; padding:8px;">RANK</th><th style="border:1px solid #ccc; padding:8px;">ID</th><th style="border:1px solid #ccc; padding:8px;">NAME</th><th colspan="${judges}" style="border:1px solid #ccc; padding:8px;">SCORES</th><th style="border:1px solid #ccc; padding:8px;">AVG</th><th style="border:1px solid #ccc; padding:8px;">STATUS</th></tr></thead><tbody>${rows}</tbody></table></body></html>`;
    const win = window.open('', '_blank'); win.document.write(html); win.document.close(); setTimeout(() => { win.focus(); win.print(); }, 500);
}

/* ============= Battle & Display ============= */
function createBattlePanels(){
  document.getElementById('battlePanels').innerHTML = ROUND_CONFIG.map(cfg=>`
    <div class="panel" id="panel${cfg.tabId}">
      <div class="status-bar">
        <div>${cfg.name}</div>
        <div>
          <button class="btn btn-green" id="nextBtn${cfg.idx}" onclick="nextRound(${cfg.idx})">ä¸‹ä¸€è½®</button>
          ${cfg.idx===4 ? '<button class="btn btn-pink" onclick="showCeremony()">ğŸ† é¢å¥–</button>' : ''}
        </div>
      </div>
      <div class="battle-container" id="battleBox${cfg.idx}"></div>
    </div>`).join('');
}
function refreshBattlePanels(){
  ROUND_CONFIG.forEach(cfg=>{
    const idx = cfg.idx;
    const round = appData.rounds[idx];
    const box = document.getElementById('battleBox'+idx);
    const btn = document.getElementById('nextBtn'+idx);
    if(!box) return;
    box.innerHTML = '';
    if(!round || !round.matches) { if(btn) { btn.disabled=true; btn.textContent = 'ç­‰å¾…ä¸Šä¸€è½®'; } return; }
    const done = round.matches.every(m=>m.winnerId);
    if(btn) { btn.disabled = !done; if(idx===4) btn.style.display='none'; }
    
    round.matches.forEach((m,i)=>{
      const p1 = m.p1||{}, p2 = m.p2||{};
      const w1 = m.winnerId===p1.id, w2 = m.winnerId===p2.id;
      const locked = !!appData.rounds[idx+1];
      const cl1 = locked?'':`onclick="setWin(${idx},${i},'${p1.id}')"`;
      const cl2 = locked?'':`onclick="setWin(${idx},${i},'${p2.id}')"`;
      // ä¿®å¤ï¼šä¸ç›´æ¥ä¼ ä¸­æ–‡åï¼Œæ”¹ä¼ ç´¢å¼•ï¼Œåœ¨ openVSScreen é‡Œè§£åŒ…
      box.innerHTML += `
      <div class="match-card">
        <div class="match-tools"><button class="btn btn-small btn-dark" onclick="openVS('${idx}','${i}')">VS</button></div>
        <div class="fighter ${w1?'winner':(m.winnerId?'loser':'')}" ${cl1}><img src="${p1.avatar||DEFAULT_AVATAR}"><div class="fighter-name">${p1.name}</div><div class="fighter-id">#${p1.id}</div></div>
        <div class="vs-tag">VS</div>
        <div class="fighter ${w2?'winner':(m.winnerId?'loser':'')}" ${cl2}><img src="${p2.avatar||DEFAULT_AVATAR}"><div class="fighter-name">${p2.name}</div><div class="fighter-id">#${p2.id}</div></div>
      </div>`;
    });
  });
}
function setWin(r,m,w){ appData.rounds[r].matches[m].winnerId = w; saveToCloud(); refreshBattlePanels(); }
function nextRound(idx){
  if(idx===4)return;
  if(!confirm('ç”Ÿæˆä¸‹ä¸€è½®ï¼Ÿ'))return;
  const cur = appData.rounds[idx].matches;
  const next = [];
  for(let i=0; i<cur.length; i+=2){
    const w1 = cur[i].winnerId===cur[i].p1.id ? cur[i].p1 : cur[i].p2;
    const w2 = cur[i+1].winnerId===cur[i+1].p1.id ? cur[i+1].p1 : cur[i+1].p2;
    next.push({ id:next.length+1, p1:w1, p2:w2, winnerId:null });
  }
  appData.rounds[idx+1] = { matches:next };
  appData.rounds[idx+1].matches.forEach(m=>{ if(m.p1.isBye) m.winnerId=m.p2.id; if(m.p2.isBye) m.winnerId=m.p1.id; });
  saveToCloud(); refreshUI(); switchTab(idx+3);
}

// ä¿®å¤åçš„ VS å¤§å±è°ƒç”¨ï¼šé€šè¿‡ç´¢å¼•æŸ¥æ‰¾ï¼Œä¸ä¼ å­—ç¬¦ä¸²é¿å…ä¹±ç 
function openVS(rIdx, mIdx){
  const m = appData.rounds[rIdx].matches[mIdx];
  const p1 = m.p1, p2 = m.p2;
  document.getElementById('vsName1').innerText=p1.name; document.getElementById('vsId1').innerText='#'+p1.id; document.getElementById('vsAvatar1').src=p1.avatar||DEFAULT_AVATAR;
  document.getElementById('vsName2').innerText=p2.name; document.getElementById('vsId2').innerText='#'+p2.id; document.getElementById('vsAvatar2').src=p2.avatar||DEFAULT_AVATAR;
  document.getElementById('vsScreen').style.display='flex';
}

function showCeremony(){
  const fr = appData.rounds[4];
  if(!fr || !fr.matches[0].winnerId){ alert('è¯·å…ˆå†³å‡ºå† å†›'); return; }
  const m = fr.matches[0];
  const champ = m.winnerId===m.p1.id?m.p1:m.p2;
  const run = m.winnerId===m.p1.id?m.p2:m.p1;
  const sr = appData.rounds[3];
  const thirds=[];
  if(sr){ sr.matches.forEach(sm=>{ if(sm.winnerId){ const l=sm.winnerId===sm.p1.id?sm.p2:sm.p1; if(l&&l.id!=='BYE') thirds.push(l); } }); }
  const p = document.getElementById('podiumContent'); p.innerHTML='';
  if(run) p.innerHTML += createCeremonyBlock(run,'second','2ND');
  p.innerHTML += createCeremonyBlock(champ,'first','WINNER');
  thirds.forEach(t=> p.innerHTML += createCeremonyBlock(t,'third','3RD'));
  document.getElementById('ceremonyScreen').style.display='flex';
  fireConfetti();
}
function createCeremonyBlock(player, rankClass, label){
  return `<div class="rank-col ${rankClass}">${rankClass==='first'?'<div class="crown">ğŸ‘‘</div>':''}<div class="avatar-box"><img src="${player.avatar||DEFAULT_AVATAR}"></div><div class="info-box"><div class="p-name">${player.name}</div><div class="p-id">#${player.id}</div><div class="p-rank">${label}</div></div></div>`;
}
function fireConfetti(){ confetti({particleCount:150,spread:100,origin:{y:0.6}}); }
function switchTab(n){ document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===n)); document.querySelectorAll('.panel').forEach((p,i)=>p.classList.toggle('active',i===n)); }
function showQR(){ const u=prompt("Register URL:",window.location.href.replace('admin_qr.html','register.html')); if(u){document.getElementById('qrcode').innerHTML="";new QRCode(document.getElementById('qrcode'),{text:u,width:256,height:256});document.getElementById('qrModal').style.display='flex';} }
function clearAll(){ if(confirm('RESET ALL?')){appData={players:[],audition:{finished:false,results:[]},judgeCount:3,rounds:[]};saveToCloud();refreshUI();} }
</script>
</body>
</html>
