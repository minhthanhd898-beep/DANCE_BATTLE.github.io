<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>STREET WARS PRO - MERCHANT LOGIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Permanent+Marker&family=Rubik+Glitch&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  /* ä¿æŒåŸæœ‰å˜»å“ˆæ ·å¼ï¼Œæ–°å¢ç™»å½•é¡µæ ·å¼ */
  :root { --cyan: #00f7ff; --pink: #ff0099; --lime: #ccff00; --yellow: #ffee00; --bg: #0f0f0f; }
  body { background: var(--bg) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill-opacity="0.05"><path d="M0 60 L60 0 H30 L0 30 Z" fill="white"/></svg>'); color: #eee; font-family: "Microsoft YaHei", sans-serif; margin: 0; padding: 20px; overflow-x: hidden; }
  .container { display:none; max-width: 1300px; margin: 0 auto; background: rgba(20,20,20,0.95); border: 4px solid #fff; box-shadow: 10px 10px 0 #000; padding: 10px; min-height: 800px; }
  
  /* ... (æ­¤å¤„çœç•¥éƒ¨åˆ†é€šç”¨ CSSï¼Œä¸ä¸Šä¸€ç‰ˆå®Œå…¨ä¸€è‡´ï¼Œä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¯·ç›´æ¥å¤ç”¨ä¸Šä¸€ç‰ˆçš„ CSS æ ¸å¿ƒéƒ¨åˆ†) ... */
  /* ä¸ºäº†æ¼”ç¤ºå®Œæ•´æ€§ï¼Œè¿™é‡Œåˆ—å‡ºå…³é”®çš„é€šç”¨ç±» */
  .btn { font-family: 'Black Ops One'; border: none; padding: 8px 20px; margin: 5px; cursor: pointer; transform: skewX(-10deg); transition: 0.2s; }
  .btn:hover { transform: skewX(-10deg) translate(-2px,-2px); box-shadow: 4px 4px 0 #000; }
  .btn-green { background: var(--lime); color: #000; }
  .btn-blue { background: var(--cyan); color: #000; }
  .btn-pink { background: var(--pink); color: #fff; }
  .btn-dark { background: #333; color: #fff; }
  
  /* === ğŸ” ç™»å½•ç•Œé¢ (Login Overlay) === */
  #loginScreen {
    position: fixed; inset: 0; z-index: 10000;
    background: #000;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background-image: radial-gradient(circle at 50% 50%, #222 0%, #000 100%);
  }
  .login-box {
    width: 350px; padding: 40px;
    border: 4px solid var(--cyan);
    box-shadow: 0 0 30px var(--cyan);
    text-align: center;
    background: rgba(0,0,0,0.8);
  }
  .login-title { font-family: 'Rubik Glitch'; font-size: 40px; color: #fff; margin-bottom: 30px; text-shadow: 2px 2px 0 var(--pink); }
  .login-input {
    width: 100%; padding: 15px; margin-bottom: 15px;
    background: #111; border: 2px solid #555; color: #fff;
    font-family: 'Black Ops One'; font-size: 18px; text-align: center;
    box-sizing: border-box;
  }
  .login-input:focus { border-color: var(--lime); outline: none; }
  .error-msg { color: var(--pink); margin-top: 10px; display: none; font-weight: bold; }
  
  /* å¤ç”¨åŸæœ‰æ ·å¼ */
  header { text-align: center; padding: 30px; border-bottom: 3px dashed var(--pink); }
  h1 { font-family: 'Rubik Glitch', cursive; font-size: 50px; margin: 0; text-shadow: 4px 4px 0 var(--pink); }
  .tabs { display: flex; justify-content: center; gap: 15px; padding: 20px; border-bottom: 5px solid var(--cyan); }
  .tab { font-family: 'Black Ops One'; font-size: 16px; padding: 8px 15px; cursor: pointer; background: #222; border: 2px solid #555; transform: skewX(-15deg); transition:0.3s; }
  .tab.active { background: var(--cyan); color: #000; border-color: #fff; transform: skewX(-15deg) scale(1.1); box-shadow: 0 0 15px var(--cyan); }
  .panel { display: none; padding: 30px; animation: fadeIn 0.3s; }
  .panel.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  input { background: transparent; border: 1px solid #555; color: #fff; padding: 5px; text-align: center; font-family: 'Black Ops One'; font-size: 18px; }
  .status-bar { background: #000; border: 2px solid #444; padding: 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom:20px; }
  .search-input { width: 180px; border-bottom: 2px solid var(--lime); font-size: 16px; text-align: left; padding-left: 10px; color: var(--lime); }
  table { width: 100%; border-collapse: separate; border-spacing: 0 6px; }
  th { color: #888; font-size: 14px; border-bottom: 2px solid #333; padding: 6px; }
  td { background: #111; padding: 6px; border-top: 1px solid #222; border-bottom: 1px solid #222; vertical-align: middle; text-align: center; }
  .avatar-sm { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
  .top-rank td { border-top: 1px dashed var(--cyan); border-bottom: 1px dashed var(--cyan); background: rgba(0, 247, 255, 0.05); }
  .rank-num { font-family: 'Rubik Glitch'; font-size: 20px; color: #777; }
  .top-rank .rank-num { color: var(--cyan); text-shadow: 0 0 2px rgba(0,247,255,0.7); }
  .battle-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 20px; margin-top: 20px; }
  .match-card { position: relative; background:#000; border:2px solid #fff; display:flex; align-items:center; justify-content:space-between; padding:10px; box-shadow:5px 5px 0 #000; }
  .match-tools { position:absolute; top:5px; right:5px; z-index:10; }
  .fighter { flex:1; text-align:center; padding:10px; cursor:pointer; transition:0.2s; display:flex; flex-direction:column; align-items:center; border: 1px solid transparent; }
  .fighter:hover { border-color:#555; }
  .fighter img { width:60px; height:60px; border-radius:50%; border:2px solid #fff; object-fit:cover; margin-bottom:5px; }
  .fighter.winner { background:var(--cyan); color:#000 !important; box-shadow:0 0 15px var(--cyan); transform: scale(1.05); z-index:5; }
  .fighter.loser { opacity:0.3; filter:grayscale(1); }
  .vs-tag { font-family:'Rubik Glitch'; font-size:32px; color:var(--pink); margin:0 10px; }
  #vsScreen, #ceremonyScreen, #qrModal { display: none; position: fixed; inset: 0; background: #000; z-index: 9999; }
  #vsScreen { flex-direction: row; align-items: center; }
  .vs-side { flex:1; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; }
  .vs-side.left { background:linear-gradient(135deg,#111,#000); border-right:5px solid var(--cyan); }
  .vs-side.right { background:linear-gradient(225deg,#111,#000); border-left:5px solid var(--pink); }
  .vs-avatar-big { width:300px; height:300px; border-radius:50%; border:10px solid #fff; object-fit:cover; margin-bottom:20px; }
  .vs-name-big { font-family:'Rubik Glitch'; font-size:60px; color:#fff; text-shadow:3px 3px 0 #000; }
  .vs-id-big { font-family:'Black Ops One'; font-size:32px; color:var(--yellow); background:#000; padding:4px 16px; margin-top:10px; }
  .vs-center-logo { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-family:'Rubik Glitch'; font-size:140px; color:#fff; text-shadow:0 0 30px var(--pink); pointer-events:none; }
  .close-btn { position:absolute; top:20px; right:20px; font-size:30px; color:#fff; cursor:pointer; opacity:0.6; z-index:10000; }
  #ceremonyScreen { flex-direction:column; align-items:center; justify-content:flex-end; padding-bottom:40px; }
  .ceremony-bg { position:absolute; inset:0; background: radial-gradient(circle at 50% 20%, rgba(255,255,255,0.1) 0, #000 60%); z-index:-1; }
  .ceremony-title { position:absolute; top:40px; font-family:'Rubik Glitch'; font-size:72px; color:#fff; text-shadow:0 0 25px var(--pink); animation: glow 2s infinite alternate; }
  @keyframes glow { from{text-shadow:0 0 10px var(--pink);} to{text-shadow:0 0 30px var(--pink), 0 0 10px #fff;} }
  .podium { display:flex; align-items:flex-end; gap:40px; z-index:10; }
  .rank-col { display:flex; flex-direction:column; align-items:center; transform:translateY(120%); opacity:0; }
  .animate-rise { animation: riseUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
  @keyframes riseUp { 0% { transform:translateY(120%); opacity:0; } 100% { transform:translateY(0); opacity:1; } }
  .avatar-box { width:180px; height:180px; border-radius:50%; border:8px solid #fff; overflow:hidden; margin-bottom:-40px; z-index:20; background:#000; box-shadow:0 10px 30px #000; }
  .avatar-box img { width:100%; height:100%; object-fit:cover; }
  .info-box { text-align:center; background:#111; border:3px solid #fff; padding:50px 20px 20px; width:220px; margin-top:-10px; clip-path:polygon(0 20%,100% 0,100% 100%,0 100%); }
  .rank-col.first .info-box { width:300px; padding-top:80px; background:linear-gradient(180deg,#ffd700,#b8860b); }
  .rank-col.second .info-box { background:linear-gradient(180deg,#c0c0c0,#808080); }
  .rank-col.third .info-box { background:linear-gradient(180deg,#cd7f32,#8b4513); }
  .p-name { font-family:'Permanent Marker'; font-size:24px; color:#fff; text-shadow:2px 2px 0 #000; line-height:1.1; margin-bottom:5px; }
  .first .p-name { font-size:40px; color:#000; text-shadow:none; }
  .p-id { font-family:'Black Ops One'; font-size:18px; color:#fff; background:#000; padding:2px 8px; transform:rotate(-3deg); display:inline-block; }
  .p-rank { position:absolute; bottom:5px; right:10px; font-family:'Rubik Glitch'; font-size:40px; color:rgba(0,0,0,0.3); }
  .crown { position:absolute; top:-100px; font-size:80px; animation: float 2s infinite ease-in-out; }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }
  #qrModal { flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.95); }
  #qrcode { background:#fff; padding:20px; border:4px solid var(--lime); }
</style>
</head>
<body>

<!-- ç™»å½•/ä»˜è´¹éªŒè¯é®ç½© -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-title">STREET WARS<br>LOGIN</div>
    <input type="email" id="email" class="login-input" placeholder="EMAIL (é‚®ç®±)">
    <input type="password" id="password" class="login-input" placeholder="PASSWORD (å¯†ç )">
    <button class="btn btn-green" style="width:100%; font-size:20px;" onclick="handleLogin()">ENTER SYSTEM</button>
    <div class="error-msg" id="loginError"></div>
    <p style="color:#666; margin-top:20px; font-size:12px;">Contact admin to purchase license.<br>è¯·è”ç³»ç®¡ç†å‘˜è´­ä¹°å•†ç”¨æˆæƒã€‚</p>
  </div>
</div>

<div class="container" id="mainApp">
  <header>
    <h1>STREET WARS 2025</h1>
    <p style="font-family:'Black Ops One'; color:var(--yellow);">BATTLE MANAGEMENT SYSTEM <span id="userBadge" style="font-size:12px; border:1px solid #fff; padding:2px 5px; margin-left:10px;">PRO</span></p>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)">é€‰æ‰‹åº“</div>
    <div class="tab" onclick="switchTab(1)">æµ·é€‰</div>
    <div class="tab" onclick="switchTab(2)">32å¼º</div>
    <div class="tab" onclick="switchTab(3)">16å¼º</div>
    <div class="tab" onclick="switchTab(4)">8å¼º</div>
    <div class="tab" onclick="switchTab(5)">åŠå†³èµ›</div>
    <div class="tab" onclick="switchTab(6)">å†³èµ›</div>
    <button class="btn-small btn-dark" onclick="handleLogout()" style="margin-left:auto;">é€€å‡º</button>
  </div>

  <!-- é€‰æ‰‹åº“ -->
  <div class="panel active" id="panel0">
    <div class="status-bar">
      <div>
        <input id="searchPlayer" class="search-input" placeholder="æœç´¢..." oninput="renderPlayerManager()">
        <span style="margin-left:10px;">Total: <b id="totalCount">0</b></span>
      </div>
      <div>
        <button class="btn btn-green" onclick="syncRegistration()">æ¥æ”¶æŠ¥å</button>
        <button class="btn btn-blue" onclick="showQR()">æŠ¥åäºŒç»´ç </button>
        <button class="btn btn-pink" onclick="addPlayer()">æ·»åŠ é€‰æ‰‹</button>
        <button class="btn btn-dark" onclick="resetGameOnly()">é‡ç½®æ¯”èµ›</button>
      </div>
    </div>
    <table>
      <thead><tr><th>å¤´åƒ</th><th>å·ç </th><th>å§“å</th><th>çŠ¶æ€ / æ“ä½œ</th><th>åˆ é™¤</th></tr></thead>
      <tbody id="playerListBody"></tbody>
    </table>
  </div>

  <!-- æµ·é€‰ -->
  <div class="panel" id="panel1">
    <div class="status-bar">
      <div>
        <input id="searchAudition" class="search-input" placeholder="è¾“å…¥é€‰æ‰‹..." oninput="renderScoreTable(null)">
        <span style="margin-left:10px;">è£åˆ¤æ•°ï¼š<input type="number" id="judgeCount" value="3" min="1" max="5" style="width:40px" onchange="renderScoreTable(true)"></span>
      </div>
      <div>
        <button class="btn btn-dark" onclick="renderScoreTable('id')">æŒ‰å·ç æ’åº</button>
        <button class="btn btn-blue" onclick="renderScoreTable('score')">åˆ·æ–°æ’å</button>
        <button class="btn btn-pink" onclick="exportAuditionPDF()">å¯¼å‡ºæˆç»©å•</button>
        <button class="btn btn-green" onclick="finalizeAudition()">é”å®šå¹¶æ™‹çº§ >></button>
      </div>
    </div>
    <table>
      <thead><tr id="scoreHeader"></tr></thead>
      <tbody id="scoreBody"></tbody>
    </table>
  </div>

  <div id="battlePanels"></div>
</div>

<!-- å¼¹çª—ç»„ä»¶ -->
<div id="vsScreen">
  <div class="vs-side left"><img id="vsAvatar1" class="vs-avatar-big"><div id="vsName1" class="vs-name-big"></div><div id="vsId1" class="vs-id-big"></div></div>
  <div class="vs-center-logo">VS</div>
  <div class="vs-side right"><img id="vsAvatar2" class="vs-avatar-big"><div id="vsName2" class="vs-name-big"></div><div id="vsId2" class="vs-id-big"></div></div>
  <div class="close-btn" onclick="document.getElementById('vsScreen').style.display='none'">Ã—</div>
</div>

<div id="ceremonyScreen">
  <div class="ceremony-bg"></div>
  <div class="ceremony-title">THE CHAMPIONS</div>
  <div class="close-btn" onclick="document.getElementById('ceremonyScreen').style.display='none'">Ã—</div>
  <div class="podium" id="podiumContent"></div>
</div>

<div id="qrModal">
  <div id="qrcode"></div>
  <p style="color:#fff; margin-top:20px;">SCAN TO REGISTER</p>
  <div class="close-btn" onclick="document.getElementById('qrModal').style.display='none'">å…³é—­</div>
</div>

<script>
// ========== â˜…â˜…â˜… é…ç½®åŒºåŸŸ â˜…â˜…â˜… ==========
const SB_URL = "https://htqlaedczmaezrlqmwft.supabase.co";          
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0cWxhZWRjem1hZXpybHFtd2Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTQ2NzEsImV4cCI6MjA4NTkzMDY3MX0._LB75XfBc940vgnmx95ryZxWb-AZRJmuty8B1z_x08g";     
// =========================================

const { createClient } = supabase;
const sb = (SB_URL.startsWith('http')) ? createClient(SB_URL, SB_KEY) : null;
const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjMzMzIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIvPjwvc3ZnPg==';

let appData = {
  players: [],
  audition: { finished:false, results:[] },
  judgeCount: 3,
  rounds: []   
};
let currentUser = null; // å­˜å‚¨å½“å‰ç™»å½•ç”¨æˆ·

const ROUND_CONFIG = [
  { idx:0, tabId:2, name:'32 å¼º (TOP 32)' }, { idx:1, tabId:3, name:'16 å¼º (TOP 16)' },
  { idx:2, tabId:4, name:'8 å¼º (TOP 8)' }, { idx:3, tabId:5, name:'åŠå†³èµ› (SEMI)' },
  { idx:4, tabId:6, name:'å†³èµ› (FINAL)' }
];

window.onload = async () => {
  // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
  const session = await sb.auth.getSession();
  if(session.data.session) {
      await checkLicense(session.data.session.user);
  }
};

/* ============= ğŸ” Auth & License ============= */
async function handleLogin() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const errBox = document.getElementById('loginError');
    errBox.style.display='none';

    if(!sb) { alert("Supabase not configured"); return; }

    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error) {
        errBox.innerText = "LOGIN FAILED: " + error.message;
        errBox.style.display='block';
    } else {
        await checkLicense(data.user);
    }
}

async function checkLicense(user) {
    // æ£€æŸ¥ profiles è¡¨
    const { data, error } = await sb.from('profiles').select('is_paid').eq('id', user.id).single();
    
    // å¦‚æœæ²¡æœ‰ profile æˆ–è€…æœªä»˜è´¹
    if (error || !data || !data.is_paid) {
        alert("è´¦å·æœªæ¿€æ´»æˆ–å·²è¿‡æœŸï¼è¯·è”ç³»ç®¡ç†å‘˜ä»˜è´¹ã€‚\n(Account not active or expired)");
        await sb.auth.signOut();
        return;
    }

    // éªŒè¯é€šè¿‡ï¼Œè¿›å…¥ç³»ç»Ÿ
    currentUser = user;
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('mainApp').style.display='block';
    document.getElementById('userBadge').innerText = user.email;
    
    // åŠ è½½è¯¥ç”¨æˆ·çš„æ•°æ®
    await loadFromCloud();
    initApp();
}

async function handleLogout() {
    await sb.auth.signOut();
    location.reload();
}

function initApp() {
    ensureStructures();
    createBattlePanels();
    renderPlayerManager();
    renderScoreTable(null);
    refreshBattlePanels();
    if(sb){
        // ç›‘å¬å±äºå½“å‰ç”¨æˆ·çš„æŠ¥åæ•°æ® (å‰ææ˜¯ RLS è®¾ç½®æ­£ç¡®)
        sb.channel('reg-ch').on('postgres_changes',{event:'INSERT',schema:'public',table:'registrations'}, ()=>syncRegistration()).subscribe();
    }
}

/* ============= Cloud (Multi-Tenant) ============= */
async function loadFromCloud(){
  try{
    if(!currentUser) return;
    // è¯»å– ID ä¸å½“å‰ User ID åŒ¹é…çš„æ•°æ® (æˆ‘ä»¬åœ¨ SQL é‡ŒæŠŠ id ç±»å‹æ”¹ä¸ºäº† text/uuid)
    const {data} = await sb.from('game_state').select('data').eq('id', currentUser.id).maybeSingle();
    if(data && data.data) appData = data.data;
  }catch(e){console.error(e);}
}

async function saveToCloud(){
  if(!sb || !currentUser) return;
  await sb.from('game_state').upsert({id: currentUser.id, data: appData});
}

async function syncRegistration(){
  if(!sb || !currentUser){ alert("Error"); return; }
  // æŠ¥åç«¯éœ€è¦ä¿®æ”¹ï¼šåœ¨ä¸Šä¼ æ—¶å¸¦ä¸Š owner_id (å•†æˆ·ID)ã€‚
  // æš‚æ—¶æ–¹æ¡ˆï¼šè¿™é‡Œå‡è®¾ registrations è¡¨å·²ç»å¼€å¯ RLSï¼Œåªèƒ½è¯»åˆ°å±äºè‡ªå·±çš„ï¼Œæˆ–è€…è¯»å…¨éƒ¨å†ç­›é€‰
  // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨ register.html é‡Œéœ€è¦è®©ç”¨æˆ·å¡«ä¸€ä¸ªâ€œå•†æˆ·ç â€æˆ–è€…é€šè¿‡ URL å‚æ•°ä¼ é€’å•†æˆ· ID
  // è¿™é‡Œæš‚æ—¶æ¼”ç¤ºè¯»å–æ‰€æœ‰æœªå¤„ç†çš„ï¼ˆå‡è®¾ RLS ç”Ÿæ•ˆï¼‰
  
  const {data} = await sb.from('registrations').select('*').eq('processed',false);
  
  if(data && data.length){
    let count = 0;
    data.forEach(row=>{
      // è¿™é‡Œå¯ä»¥åŠ é€»è¾‘ï¼šåªæœ‰ owner_id åŒ¹é…æ‰æ¥æ”¶
      // if (row.owner_id === currentUser.id) ...
      if(!appData.players.some(p=>p.id===row.player_id)){
        appData.players.push({ id: row.player_id, name: row.player_name, avatar: row.avatar || DEFAULT_AVATAR });
        count++;
      }
    });
    // æ ‡è®°
    await sb.from('registrations').update({processed:true}).in('id',data.map(d=>d.id));
    alert(`æˆåŠŸæ¥æ”¶ ${count} ä½æ–°é€‰æ‰‹`);
    refreshUI();
    saveToCloud();
  } else alert("æš‚æ— æ–°æŠ¥å");
}

/* ============= (ä»¥ä¸‹ä¸šåŠ¡é€»è¾‘ä¸ä¸Šä¸€ç‰ˆä¿æŒå®Œå…¨ä¸€è‡´) ============= */
function refreshUI(){ renderPlayerManager(); renderScoreTable(null); }
function ensureStructures(){ if(!appData.players) appData.players=[]; if(!appData.audition) appData.audition={finished:false,results:[]}; if(!Array.isArray(appData.audition.results)) appData.audition.results=[]; if(!Array.isArray(appData.rounds)) appData.rounds=[]; }
function addPlayer(){ appData.players.push({id:'',name:'',avatar:DEFAULT_AVATAR}); renderPlayerManager(); saveToCloud(); }
function renderPlayerManager(){ const term=document.getElementById('searchPlayer').value.toLowerCase(); const tb=document.getElementById('playerListBody'); tb.innerHTML=''; appData.players.forEach((p,i)=>{ if(term && !p.id.toLowerCase().includes(term) && !p.name.toLowerCase().includes(term)) return; const inAudition=appData.audition.results.some(r=>r.id===p.id); const btn=inAudition?`<button class="btn-small btn-green" disabled>âœ… å·²å‚èµ›</button>`:`<button class="btn-small btn-blue" onclick="addToAudition(${i})">â• å‚åŠ æµ·é€‰</button>`; tb.innerHTML+=`<tr><td><img src="${p.avatar||DEFAULT_AVATAR}" class="avatar-sm"></td><td><input value="${p.id}" oninput="updatePlayerInfo(${i},'id',this.value)"></td><td><input style="text-align:left;" value="${p.name}" oninput="updatePlayerInfo(${i},'name',this.value)"></td><td>${btn}</td><td><button class="btn-small btn-dark" onclick="removePlayer(${i})">ğŸ—‘ï¸</button></td></tr>`; }); document.getElementById('totalCount').innerText=appData.players.length; }
function updatePlayerInfo(i,f,v){ appData.players[i][f]=v; const pid=appData.players[i].id; const audP=appData.audition.results.find(r=>r.id===pid); if(audP){audP[f]=v;renderScoreTable(null);} saveToCloud(); }
function addToAudition(i){ const p=appData.players[i]; if(!p.id||!p.name){alert("ä¿¡æ¯ä¸å…¨");return;} if(appData.audition.results.some(r=>r.id===p.id))return; appData.audition.results.push({id:p.id,name:p.name,avatar:p.avatar||DEFAULT_AVATAR,scores:[],avg:0,rank:0}); saveToCloud(); renderPlayerManager(); renderScoreTable(null); }
function removeFromAudition(pid){ if(appData.audition.finished){alert("å·²é”å®š");return;} if(!confirm("ç§»å‡ºï¼Ÿ"))return; appData.audition.results=appData.audition.results.filter(r=>r.id!==pid); saveToCloud(); renderPlayerManager(); renderScoreTable(null); }
function removePlayer(i){ if(confirm('åˆ ?')){ const pid=appData.players[i].id; appData.players.splice(i,1); appData.audition.results=appData.audition.results.filter(r=>r.id!==pid); refreshUI(); saveToCloud(); } }
function resetGameOnly(){ if(confirm("ä¿ç•™é€‰æ‰‹æ¸…ç©ºæ¯”èµ›ï¼Ÿ")){ appData.audition={finished:false,results:[]}; appData.rounds=[]; refreshUI(); saveToCloud(); } }
function renderScoreTable(mode){ ensureStructures(); const judges=parseInt(document.getElementById('judgeCount').value)||3; const st=document.getElementById('searchAudition').value.toLowerCase(); appData.judgeCount=judges; document.getElementById('scoreHeader').innerHTML=`<th>å¤´åƒ</th><th>æ’å</th><th>å·ç </th><th>å§“å</th><th>å¹³å‡åˆ†</th>`+Array(judges).fill(0).map((_,i)=>`<th>J${i+1}</th>`).join('')+`<th>æ“ä½œ</th>`; appData.audition.results.forEach(p=>{ let s=0,c=0; for(let i=0;i<judges;i++){ let v=parseFloat(p.scores?.[i]); if(!isNaN(v)){s+=v;c++;} } p.avg=c?s/c:0; }); if(mode==='score'||appData.audition.finished){ appData.audition.results.sort((a,b)=>b.avg-a.avg||a.id.localeCompare(b.id)); appData.audition.results.forEach((p,i)=>p.rank=i+1); } else if(mode==='id'){ appData.audition.results.sort((a,b)=>a.id.localeCompare(b.id,undefined,{numeric:true})); } const tb=document.getElementById('scoreBody'); tb.innerHTML=''; appData.audition.results.forEach(p=>{ if(st&&!p.id.toLowerCase().includes(st)&&!p.name.toLowerCase().includes(st))return; const top=p.rank>0&&p.rank<=32; const rd=(mode==='id'&&!appData.audition.finished)?'-':(p.rank||'-'); const rm=appData.audition.finished?'':`<button class="btn-small btn-dark" onclick="removeFromAudition('${p.id}')">ç§»å‡º</button>`; tb.innerHTML+=`<tr ${top?'class="top-rank"':''}><td><img src="${p.avatar||DEFAULT_AVATAR}" class="avatar-sm"></td><td class="rank-num">${rd}</td><td>${p.id}</td><td style="text-align:left;">${p.name}</td><td style="color:${top?'var(--cyan)':'var(--pink)'};font-weight:bold;">${p.avg.toFixed(2)}</td>${Array(judges).fill(0).map((_,j)=>`<td><input type="number" step="0.1" value="${p.scores?.[j]??''}" ${appData.audition.finished?'disabled':''} oninput="onScoreInput('${p.id}',${j},this.value)"></td>`).join('')}<td>${rm}</td></tr>`; }); }
function onScoreInput(pid,idx,v){ const p=appData.audition.results.find(x=>x.id===pid); if(p){if(!p.scores)p.scores=[];p.scores[idx]=v;saveToCloud();} }
function exportAuditionPDF(){ const j=appData.judgeCount; let l=[...appData.audition.results].sort((a,b)=>b.avg-a.avg||a.id.localeCompare(b.id)); let r=l.map((p,i)=>{ const top=(i+1)<=32; const bg=top?'background-color:#d1fae5;font-weight:bold;':''; const sc=Array(j).fill(0).map((_,k)=>`<td style="border:1px solid #ccc;padding:5px;">${p.scores[k]||'-'}</td>`).join(''); return `<tr style="${bg}"><td style="border:1px solid #ccc;padding:5px;">${i+1}</td><td style="border:1px solid #ccc;padding:5px;">${p.id}</td><td style="border:1px solid #ccc;padding:5px;text-align:left;">${p.name}</td>${sc}<td style="border:1px solid #ccc;padding:5px;">${Number(p.avg).toFixed(2)}</td><td style="border:1px solid #ccc;padding:5px;">${top?'âœ…':''}</td></tr>`; }).join(''); const h=`<h1>AUDITION REPORT</h1><table style="width:100%;border-collapse:collapse;text-align:center;"><thead><tr><th>RK</th><th>ID</th><th>NAME</th><th colspan="${j}">SCORES</th><th>AVG</th><th>ST</th></tr></thead><tbody>${r}</tbody></table>`; const w=window.open('','_blank'); w.document.write('<html><body style="font-family:sans-serif;">'+h+'</body></html>'); w.document.close(); setTimeout(()=>w.print(),500); }
function finalizeAudition(){ if(appData.audition.finished){alert('Locked');return;} renderScoreTable('score'); let top32=appData.audition.results.slice(0,32); if(top32.length<32){ if(!confirm(`ä»…${top32.length}äººï¼Œå¡«å……BYEï¼Ÿ`))return; const n=32-top32.length; for(let i=0;i<n;i++)top32.push({id:'BYE',name:'BYE',avatar:DEFAULT_AVATAR,isBye:true,scores:[],avg:0}); } else { if(!confirm('é”å®šå¹¶ç”Ÿæˆ32å¼ºï¼Ÿ'))return; } appData.audition.finished=true; appData.audition.results=top32; const seed=[[1,32],[16,17],[9,24],[8,25],[5,28],[12,21],[13,20],[4,29],[3,30],[14,19],[11,22],[6,27],[7,26],[10,23],[15,18],[2,31]]; appData.rounds[0]={matches:seed.map((p,i)=>({id:i+1,p1:top32[p[0]-1],p2:top32[p[1]-1],winnerId:null}))}; appData.rounds[0].matches.forEach(m=>{if(m.p1.isBye)m.winnerId=m.p2.id;if(m.p2.isBye)m.winnerId=m.p1.id;}); saveToCloud(); refreshBattlePanels(); switchTab(2); }
function createBattlePanels(){ document.getElementById('battlePanels').innerHTML=ROUND_CONFIG.map(c=>`<div class="panel" id="panel${c.tabId}"><div class="status-bar"><div>${c.name}</div><div><button class="btn btn-green" id="nextBtn${c.idx}" onclick="nextRound(${c.idx})">ä¸‹ä¸€è½®</button>${c.idx===4?'<button class="btn btn-pink" onclick="showCeremony()">ğŸ† é¢å¥–</button>':''}</div></div><div class="battle-container" id="battleBox${c.idx}"></div></div>`).join(''); }
function refreshBattlePanels(){ ROUND_CONFIG.forEach(c=>{ const r=appData.rounds[c.idx], b=document.getElementById('battleBox'+c.idx), btn=document.getElementById('nextBtn'+c.idx); if(!b)return; b.innerHTML=''; if(!r||!r.matches){ if(btn){btn.disabled=true;btn.textContent='ç­‰å¾…ä¸Šä¸€è½®';} return; } const d=r.matches.every(m=>m.winnerId); if(btn){btn.disabled=!d;if(c.idx===4)btn.style.display='none';} r.matches.forEach((m,i)=>{ const p1=m.p1||{}, p2=m.p2||{}, w1=m.winnerId===p1.id, w2=m.winnerId===p2.id, lk=!!appData.rounds[c.idx+1]; const c1=lk?'':`onclick="setWin(${c.idx},${i},'${p1.id}')"`, c2=lk?'':`onclick="setWin(${c.idx},${i},'${p2.id}')"`; b.innerHTML+=`<div class="match-card"><div class="match-tools"><button class="btn-small btn-dark" onclick="openVS('${c.idx}','${i}')">VS</button></div><div class="fighter ${w1?'winner':(m.winnerId?'loser':'')}" ${c1}><img src="${p1.avatar||DEFAULT_AVATAR}"><div class="fighter-name">${p1.name}</div></div><div class="vs-tag">VS</div><div class="fighter ${w2?'winner':(m.winnerId?'loser':'')}" ${c2}><img src="${p2.avatar||DEFAULT_AVATAR}"><div class="fighter-name">${p2.name}</div></div></div>`; }); }); }
function setWin(r,m,w){ appData.rounds[r].matches[m].winnerId=w; saveToCloud(); refreshBattlePanels(); }
async function nextRound(i){ if(i===4)return; if(!confirm('Next?'))return; const cur=appData.rounds[i].matches, next=[]; for(let k=0;k<cur.length;k+=2){ const w1=getW(cur[k]), w2=getW(cur[k+1]); next.push({id:next.length+1,p1:w1,p2:w2,winnerId:null}); } appData.rounds[i+1]={matches:next}; appData.rounds[i+1].matches.forEach(m=>{if(m.p1.isBye)m.winnerId=m.p2.id;if(m.p2.isBye)m.winnerId=m.p1.id}); await saveToCloud(); refreshBattlePanels(); setTimeout(()=>switchTab(i+3),50); }
function getW(m){ if(!m)return {id:'BYE',name:'BYE',avatar:DEFAULT_AVATAR,isBye:true}; if(m.winnerId===m.p1.id)return m.p1; if(m.winnerId===m.p2.id)return m.p2; return {id:'BYE',name:'BYE',avatar:DEFAULT_AVATAR,isBye:true}; }
function openVS(r,m){ const mat=appData.rounds[r].matches[m]; document.getElementById('vsName1').innerText=mat.p1.name; document.getElementById('vsId1').innerText='#'+mat.p1.id; document.getElementById('vsAvatar1').src=mat.p1.avatar||DEFAULT_AVATAR; document.getElementById('vsName2').innerText=mat.p2.name; document.getElementById('vsId2').innerText='#'+mat.p2.id; document.getElementById('vsAvatar2').src=mat.p2.avatar||DEFAULT_AVATAR; document.getElementById('vsScreen').style.display='flex'; }
function showCeremony(){ const fr=appData.rounds[4]; if(!fr||!fr.matches[0].winnerId){alert('No Winner');return;} const m=fr.matches[0], ch=m.winnerId===m.p1.id?m.p1:m.p2, ru=m.winnerId===m.p1.id?m.p2:m.p1; const sr=appData.rounds[3], th=[]; if(sr)sr.matches.forEach(s=>{if(s.winnerId){const l=s.winnerId===s.p1.id?s.p2:s.p1; if(l&&l.id!=='BYE')th.push(l)}}); const b=document.getElementById('podiumContent'); b.innerHTML=''; b.innerHTML+=mkPod(ru,'second','2ND'); b.innerHTML+=mkPod(ch,'first','WINNER'); th.forEach(t=>b.innerHTML+=mkPod(t,'third','3RD')); document.getElementById('ceremonyScreen').style.display='flex'; setTimeout(()=>fireConfetti(),100); }
function mkPod(p,c,l){ return `<div class="rank-col ${c} animate-rise">${c==='first'?'<div class="crown">ğŸ‘‘</div>':''}<div class="avatar-box"><img src="${p.avatar||DEFAULT_AVATAR}"></div><div class="info-box"><div class="p-name">${p.name}</div><div class="p-id">#${p.id}</div><div class="p-rank">${l}</div></div></div>`; }
function fireConfetti(){ var d=3000, e=Date.now()+d, def={startVelocity:30,spread:360,ticks:60,zIndex:10000}; var i=setInterval(function(){ var t=e-Date.now(); if(t<=0)return clearInterval(i); var p=50*(t/d); confetti(Object.assign({},def,{particleCount:p,origin:{x:0.1,y:0.6}})); confetti(Object.assign({},def,{particleCount:p,origin:{x:0.9,y:0.6}})); },250); }
function switchTab(n){ document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===n)); document.querySelectorAll('.panel').forEach((p,i)=>p.classList.toggle('active',i===n)); }
function showQR(){ const u=prompt("Register URL:",window.location.href.replace('admin_qr.html','register.html')); if(u){document.getElementById('qrcode').innerHTML="";new QRCode(document.getElementById('qrcode'),{text:u,width:256,height:256});document.getElementById('qrModal').style.display='flex';} }
function clearAll(){ if(confirm('RESET ALL?')){ appData={players:[],audition:{finished:false,results:[]},judgeCount:3,rounds:[]}; saveToCloud(); refreshUI(); } }
</script>
</body>
</html>
