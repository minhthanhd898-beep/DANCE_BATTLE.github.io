<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>STREET WARS 2025 - ADMIN CONTROL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Permanent+Marker&family=Rock+Salt&family=Rubik+Glitch&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  /* --- ‰øùÊåÅÂòªÂìà CSS --- */
  :root { --spray-cyan: #00f7ff; --spray-pink: #ff0099; --spray-lime: #b6e000; --spray-yellow: #ffb300; --brick-dark: #0f0f0f; --font-graffiti: "Permanent Marker", cursive; --font-stencil: "Black Ops One", cursive; --font-glitch: "Rubik Glitch", cursive; --font-tag: "Rock Salt", cursive; --font-cn: "Microsoft YaHei", sans-serif; }
  body { background-color: #111; background-image: linear-gradient(335deg, rgba(0,0,0,0.8) 23px, transparent 23px), linear-gradient(155deg, rgba(0,0,0,0.8) 23px, transparent 23px); background-size: 58px 58px; color: #eee; font-family: var(--font-cn); margin: 0; padding: 20px; }
  .container { max-width: 1300px; margin: 0 auto; background: rgba(20, 20, 20, 0.95); border: 4px solid #fff; box-shadow: 10px 10px 0px #000; padding: 10px; clip-path: polygon(0% 5px, 5px 0%, 99% 0%, 100% 5px, 100% 99%, 99% 100%, 0% 100%); }
  header { text-align: center; padding: 30px; border-bottom: 3px dashed var(--spray-pink); }
  h1 { font-family: var(--font-glitch); font-size: 50px; margin: 0; color: #fff; text-shadow: 4px 4px 0px var(--spray-pink), -2px -2px 0 var(--spray-cyan); transform: rotate(-2deg); display: inline-block; }
  .sub-title { font-family: var(--font-stencil); color: var(--spray-yellow); font-size: 16px; letter-spacing: 2px; margin-top: 5px; text-transform: uppercase; }
  .en-sub { display: block; font-family: var(--font-stencil); font-size: 0.6em; opacity: 0.8; margin-top: 2px; font-weight: normal; letter-spacing: 1px; }
  .tabs { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 20px; background: #000; border-bottom: 5px solid var(--spray-cyan); }
  .tab { font-family: var(--font-cn); font-weight: bold; font-size: 16px; padding: 8px 15px; cursor: pointer; background: #222; color: #aaa; border: 2px solid #555; transform: rotate(-1deg); transition: 0.2s; box-shadow: 3px 3px 0 #000; text-align: center; }
  .tab.active { background: var(--spray-cyan); color: #000; border-color: #fff; box-shadow: 0 0 15px rgba(0, 247, 255, 0.6); transform: scale(1.05) rotate(-2deg); }
  .panel { display: none; padding: 30px; background: radial-gradient(circle at top right, rgba(0, 247, 255, 0.08), transparent 40%), radial-gradient(circle at bottom left, rgba(255, 0, 153, 0.08), transparent 40%); min-height: 600px; animation: sprayIn 0.4s ease-out; }
  .panel.active { display: block; }
  @keyframes sprayIn { from { opacity: 0; filter: blur(5px); } to { opacity: 1; filter: blur(0); } }
  .status-bar { background: #000; padding: 15px; border: 2px solid #444; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background-image: linear-gradient(0deg, transparent 24%, rgba(255,255,255,.05) 25%, rgba(255,255,255,.05) 26%, transparent 27%, transparent 74%, rgba(255,255,255,.05) 75%, rgba(255,255,255,.05) 76%, transparent 77%, transparent); background-size: 30px 30px; }
  .btn { font-family: var(--font-cn); font-weight: bold; border: none; padding: 8px 20px; margin: 0 5px; font-size: 15px; cursor: pointer; position: relative; transition: 0.2s; box-shadow: 4px 4px 0 #000; text-align: center; }
  .btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }
  .btn-primary { background: var(--spray-pink); color: #fff; transform: rotate(-1deg); }
  .btn-green { background: var(--spray-lime); color: #000; transform: rotate(1deg); }
  .btn-blue { background: var(--spray-cyan); color: #000; }
  .btn-purple { background: #9c27b0; color: #fff; }
  .btn-small { padding: 4px 10px; font-size: 12px; background: #333; color: #fff; }
  
  /* Â§¥ÂÉèÊ†∑Âºè */
  .avatar-tiny { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; vertical-align: middle; margin-right: 10px; }
  .avatar-medium { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--spray-cyan); margin-bottom: 5px; }
  
  /* Table & Input */
  table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-top: 20px; }
  th { font-family: var(--font-cn); font-weight: bold; color: #888; font-size: 16px; text-align: center; padding-bottom: 10px; border-bottom: 2px solid #333; }
  td { background: #111; padding: 10px; text-align: center; border-top: 1px solid #222; border-bottom: 1px solid #222; font-weight: bold; font-size: 16px; color: #ddd; vertical-align: middle; }
  tr:hover td { background: #1a1a1a; color: var(--spray-cyan); }
  input[type="text"], input[type="number"] { background: transparent; border: 1px solid #333; color: #fff; font-family: var(--font-stencil); font-size: 18px; padding: 5px; text-align: center; }
  input:focus { border-color: var(--spray-pink); outline: none; color: var(--spray-pink); }
  .top-rank td { border-top: 1px dashed var(--spray-cyan); border-bottom: 1px dashed var(--spray-cyan); }
  .rank-num { font-family: var(--font-glitch); font-size: 24px; color: #555; }
  .top-rank .rank-num { color: var(--spray-cyan); text-shadow: 0 0 2px rgba(0, 247, 255, 0.5); }
  
  /* Battle Cards */
  .battle-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; margin-top: 30px; }
  .match-card { background: #000; border: 2px solid #fff; padding: 10px; display: flex; align-items: center; justify-content: space-between; box-shadow: 8px 8px 0px rgba(0,0,0,0.5); position: relative; }
  .match-header { position: absolute; top: 5px; left: 10px; font-size: 12px; color: #666; font-family: var(--font-stencil); }
  .match-tools { position: absolute; top: 5px; right: 10px; z-index: 10; }
  .fighter { flex: 1; text-align: center; padding: 20px 5px; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; }
  .fighter.winner { background-color: var(--spray-cyan); color: #000 !important; }
  .fighter.loser { opacity: 0.3; filter: grayscale(1); }
  .vs-icon { font-family: var(--font-glitch); font-size: 40px; color: var(--spray-pink); margin: 0 10px; }
  
  /* VS Screen Modal (ÂÖ®Â±èÂ§ßÂ±èÊ®°Âºè) */
  .vs-screen { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 9999; flex-direction: row; align-items: center; justify-content: center; }
  .vs-side { flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
  .vs-side.left { background: linear-gradient(135deg, #111, #000); border-right: 5px solid var(--spray-cyan); }
  .vs-side.right { background: linear-gradient(225deg, #111, #000); border-left: 5px solid var(--spray-pink); }
  .vs-avatar-big { width: 300px; height: 300px; border-radius: 50%; border: 10px solid #fff; object-fit: cover; box-shadow: 0 0 50px rgba(255,255,255,0.2); margin-bottom: 30px; }
  .vs-name-big { font-family: var(--font-glitch); font-size: 80px; color: #fff; text-transform: uppercase; margin: 0; line-height: 1; text-shadow: 5px 5px 0 #000; }
  .vs-id-big { font-family: var(--font-stencil); font-size: 40px; color: var(--spray-yellow); background: #000; padding: 5px 20px; margin-top: 10px; transform: rotate(-2deg); }
  .vs-center-logo { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-family: var(--font-glitch); font-size: 150px; color: #fff; text-shadow: 0 0 30px var(--spray-pink), 5px 5px 0 #000; z-index: 10000; pointer-events: none; animation: pulse 1s infinite; }
  .vs-close-btn { position: absolute; top: 20px; right: 20px; font-size: 30px; color: #fff; cursor: pointer; z-index: 10001; opacity: 0.5; }
  @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.1); } 100% { transform: translate(-50%, -50%) scale(1); } }

  /* Misc */
  .qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; flex-direction: column; }
  #qrcode { background: #fff; padding: 20px; border: 5px solid var(--spray-lime); }
  .sync-indicator { width: 12px; height: 12px; background: #333; border-radius: 50%; display: inline-block; margin-left: 10px; }
  .sync-active { background: var(--spray-lime); box-shadow: 0 0 10px var(--spray-lime); animation: blink 1s infinite; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1 contenteditable="true" id="eventTitle" onblur="saveToCloud()">Ë°óËàûÂ∑ÖÂ≥∞‰∫âÈú∏Ëµõ</h1>
    <div class="sub-title">STREET WARS 2025 - INTERNATIONAL BATTLE SYSTEM</div>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)">0. ÈÄâÊâãÂ∫ì</div>
    <div class="tab" onclick="switchTab(1)">1. Êµ∑ÈÄâËµõ</div>
    <div class="tab" onclick="switchTab(2)">2. 32Âº∫</div>
    <div class="tab" onclick="switchTab(3)">3. 16Âº∫</div>
    <div class="tab" onclick="switchTab(4)">4. 8Âº∫</div>
    <div class="tab" onclick="switchTab(5)">5. ÂçäÂÜ≥Ëµõ</div>
    <div class="tab" onclick="switchTab(6)">6. ÊÄªÂÜ≥Ëµõ</div>
  </div>

  <!-- Èù¢Êùø0ÔºöÈÄâÊâãÁÆ°ÁêÜ -->
  <div class="panel active" id="panel0">
    <div class="status-bar">
      <div style="display:flex; align-items:center;">
          <input type="text" id="searchPlayer" class="search-box" placeholder="SEARCH..." oninput="renderPlayerManager()">
          <span style="margin-left:20px; font-weight:bold; font-size:18px;">TOTAL: <strong id="totalCount" style="color:var(--spray-cyan)">0</strong></span>
          <div id="syncStatus" class="sync-indicator"></div>
      </div>
      <div>
        <button class="btn btn-green" onclick="syncRegistration()">üì• Êé•Êî∂Êä•Âêç</button>
        <button class="btn btn-primary" onclick="showQR()">üì± ‰∫åÁª¥Á†Å</button>
        <button class="btn btn-blue" onclick="addPlayerRow()">Ê∑ªÂä†ÈÄâÊâã</button>
        <button class="btn" style="background:#222; color:#fff;" onclick="clearAll()">ÈáçÁΩÆ</button>
      </div>
    </div>
    <table id="managerTable">
      <thead><tr><th>AVATAR</th><th>ID TAG</th><th>MC NAME</th><th>ACTION</th></tr></thead>
      <tbody id="playerListBody"></tbody>
    </table>
  </div>

  <!-- Èù¢Êùø1ÔºöÊµ∑ÈÄâ -->
  <div class="panel" id="panel1">
    <div class="status-bar">
      <span>JUDGES: <input type="number" id="judgeCount" value="3" min="1" max="5" style="width:60px;" onchange="renderScoreTable(true)"></span>
      <div>
        <button class="btn btn-blue" onclick="renderScoreTable(true)">Âà∑Êñ∞ÊéíÂêç</button>
        <button class="btn btn-green" onclick="finalizeAudition()">ÈîÅÂÆöÂπ∂ÊôãÁ∫ß >></button>
      </div>
    </div>
    <p style="color:#666; font-size:12px;">* ‰∏çË∂≥32‰∫∫Êó∂ÔºåÁ©∫Áº∫‰ΩçÂ∞ÜËá™Âä®Â°´ÂÖÖ "BYE" (ËΩÆÁ©∫)„ÄÇ</p>
    <table><thead><tr id="scoreHeader"></tr></thead><tbody id="scoreBody"></tbody></table>
  </div>
  
  <div id="battlePanels"></div>
</div>

<!-- ÂºπÁ™óÁªÑ‰ª∂ -->
<div id="qrModal" class="qr-modal">
  <div id="qrcode"></div>
  <p style="color:#fff; margin-top:20px;">SCAN TO REGISTER</p>
  <div class="qr-close" onclick="document.getElementById('qrModal').style.display='none'">[ CLOSE ]</div>
</div>

<!-- Â§ßÂ±èÂØπÊàòÁïåÈù¢ -->
<div id="vsScreen" class="vs-screen">
  <div class="vs-close-btn" onclick="document.getElementById('vsScreen').style.display='none'">√ó</div>
  <div class="vs-center-logo">VS</div>
  <div class="vs-side left">
    <img id="vsAvatar1" class="vs-avatar-big" src="">
    <h1 id="vsName1" class="vs-name-big">PLAYER 1</h1>
    <div id="vsId1" class="vs-id-big">001</div>
  </div>
  <div class="vs-side right">
    <img id="vsAvatar2" class="vs-avatar-big" src="">
    <h1 id="vsName2" class="vs-name-big">PLAYER 2</h1>
    <div id="vsId2" class="vs-id-big">002</div>
  </div>
</div>

<script>
  // ==================== ‚òÖ‚òÖ‚òÖ ÈÖçÁΩÆÂå∫Âüü ‚òÖ‚òÖ‚òÖ ====================
  const SB_URL = "YOUR_SUPABASE_URL_HERE"; 
  const SB_KEY = "YOUR_SUPABASE_ANON_KEY_HERE";
  // ============================================================

  const { createClient } = supabase;
  const _supabase = (SB_URL !== "YOUR_SUPABASE_URL_HERE") ? createClient(SB_URL, SB_KEY) : null;
  const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjMzMzIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIvPjwvc3ZnPg==';

  let appData = { players: [], audition: { finished: false, results: [] }, judgeCount: 3, rounds: [] };
  const ROUND_CONFIG = [{ idx: 0, tabId: 2, cn: '32Âº∫ÂØπÂÜ≥', en: 'TOP 32' },{ idx: 1, tabId: 3, cn: '16Âº∫ÂØπÂÜ≥', en: 'TOP 16' },{ idx: 2, tabId: 4, cn: '8Âº∫ÂØπÂÜ≥', en: 'TOP 8' },{ idx: 3, tabId: 5, cn: 'ÂçäÂÜ≥Ëµõ', en: 'SEMI FINAL' },{ idx: 4, tabId: 6, cn: 'Â∑ÖÂ≥∞ÊÄªÂÜ≥Ëµõ', en: 'FINAL' }];

  window.onload = async () => {
    await loadFromCloud();
    createBattlePanelsHtml(); 
    document.getElementById('judgeCount').value = appData.judgeCount || 3;
    renderPlayerManager(); renderScoreTable(false); refreshBattlePanels();
    if (_supabase) {
        document.getElementById('syncStatus').classList.add('sync-active');
        _supabase.channel('registrations_channel').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'registrations' }, () => syncRegistration()).subscribe();
    }
  };

  /* --- Cloud Logic --- */
  async function loadFromCloud() {
      if(!_supabase) return;
      const { data } = await _supabase.from('game_state').select('data').eq('id', 1).single();
      if (data && data.data) {
          appData = data.data;
          if(!appData.audition.results) appData.audition.results = [];
      }
  }
  async function saveToCloud() {
      if(!_supabase) return;
      await _supabase.from('game_state').upsert({ id: 1, data: appData });
  }
  async function syncRegistration() {
      if(!_supabase) { alert("Config Supabase First!"); return; }
      const { data } = await _supabase.from('registrations').select('*').eq('processed', false);
      if(data && data.length > 0) {
          data.forEach(reg => {
              if(!appData.players.some(p => p.id === reg.player_id)) {
                  appData.players.push({ id: reg.player_id, name: reg.player_name, avatar: reg.avatar });
              }
          });
          const ids = data.map(d => d.id);
          await _supabase.from('registrations').update({ processed: true }).in('id', ids);
          saveToCloud(); refreshAllUI();
      }
  }
  function refreshAllUI() { renderPlayerManager(); if(!appData.audition.finished) syncAuditionList(); renderScoreTable(false); refreshBattlePanels(); }

  /* --- Player Manager --- */
  function addPlayerRow() { document.getElementById('searchPlayer').value=''; appData.players.push({id:'',name:'',avatar:''}); renderPlayerManager(); saveToCloud(); }
  function renderPlayerManager() {
    const term = document.getElementById('searchPlayer').value.toLowerCase();
    const tbody = document.getElementById('playerListBody'); tbody.innerHTML = '';
    appData.players.forEach((p, idx) => {
        if(term && !p.id.toLowerCase().includes(term) && !p.name.toLowerCase().includes(term)) return;
        const av = p.avatar || DEFAULT_AVATAR;
        tbody.innerHTML += `<tr><td><img src="${av}" class="avatar-tiny"></td><td><input type="text" value="${p.id}" oninput="appData.players[${idx}].id=this.value;saveToCloud();" style="color:var(--spray-cyan)"></td><td><input type="text" value="${p.name}" style="width:100%;text-align:left;" oninput="appData.players[${idx}].name=this.value;saveToCloud();"></td><td><button class="btn-small" onclick="delPlayer(${idx})">DEL</button></td></tr>`;
    });
    document.getElementById('totalCount').innerText = appData.players.length;
  }
  function delPlayer(i) { if(confirm('Delete?')) { appData.players.splice(i,1); saveToCloud(); refreshAllUI(); } }

  /* --- Audition --- */
  function syncAuditionList() {
      if(appData.audition.finished) return;
      const map = {}; appData.audition.results.forEach(r=>{map[r.id]=r.scores||[]});
      appData.audition.results = appData.players.map(p=>({id:p.id, name:p.name, avatar:p.avatar, scores:map[p.id]||[], avg:0, rank:0}));
  }
  function renderScoreTable(sort) {
      const judges = parseInt(document.getElementById('judgeCount').value)||3; appData.judgeCount=judges;
      document.getElementById('scoreHeader').innerHTML = `<th>AVATAR</th><th>RANK</th><th>ID</th><th>NAME</th><th>AVG</th>${Array(judges).fill(0).map((_,i)=>`<th>J${i+1}</th>`).join('')}`;
      let list = [...appData.audition.results];
      list.forEach(p=>{
          let sum=0,c=0; for(let i=0;i<judges;i++){ let v=parseFloat(p.scores[i]); if(!isNaN(v)){sum+=v;c++}}
          p.avg=c>0?sum/c:0;
      });
      if(sort||appData.audition.finished){ list.sort((a,b)=>b.avg-a.avg||a.id.localeCompare(b.id)); list.forEach((p,i)=>p.rank=i+1); if(appData.audition.finished) appData.audition.results=list; }
      let h='';
      list.forEach(p=>{
          const cls = (p.rank>0&&p.rank<=32)?'class="top-rank"':'';
          const av = p.avatar || DEFAULT_AVATAR;
          h+=`<tr ${cls}><td><img src="${av}" class="avatar-tiny"></td><td class="rank-num">${p.rank||'-'}</td><td style="font-family:var(--font-tag)">${p.id}</td><td style="text-align:left;">${p.name}</td><td style="color:var(--spray-pink);font-size:20px;">${Number(p.avg).toFixed(2)}</td>`;
          for(let j=0;j<judges;j++){ h+=`<td><input type="number" step="0.1" value="${p.scores[j]||''}" ${appData.audition.finished?'disabled':''} oninput="scoreIn('${p.id}',${j},this.value)"></td>`; }
          h+='</tr>';
      });
      document.getElementById('scoreBody').innerHTML=h;
  }
  function scoreIn(id,idx,val){ const p=appData.audition.results.find(x=>x.id===id); if(p){p.scores[idx]=val;saveToCloud();} }
  
  // Ê†∏ÂøÉÈÄªËæë‰øÆÊîπÔºö‰∏çË∂≥32‰∫∫Â°´ÂÖÖ BYE
  function finalizeAudition() {
      if(appData.audition.finished){alert('LOCKED');return;}
      renderScoreTable(true);
      // Ëé∑ÂèñÂÆûÈôÖÈÄâÊâã
      let top32 = appData.audition.results.slice(0,32);
      
      // Â°´ÂÖÖÈÄªËæë (Filling Logic)
      if(top32.length < 32) {
          const needed = 32 - top32.length;
          if(!confirm(`Only ${top32.length} players. Fill ${needed} slots with BYE?`)) return;
          for(let i=0; i<needed; i++) {
              top32.push({ id: 'BYE', name: 'BYE (ËΩÆÁ©∫)', avatar: DEFAULT_AVATAR, isBye: true });
          }
      } else {
          if(!confirm('Lock Audition & Start Battle?')) return;
      }

      appData.audition.finished=true;
      const seed = [[1,32], [16,17], [9,24], [8,25], [5,28], [12,21], [13,20], [4,29], [3,30], [14,19], [11,22], [6,27], [7,26], [10,23], [15,18], [2,31]];
      appData.rounds[0] = { matches: seed.map((p,i)=>({id:i+1, p1:top32[p[0]-1], p2:top32[p[1]-1], winnerId:null})) };
      
      // Ëá™Âä®Âà§ÂÆö BYE ÁöÑÊØîËµõ
      appData.rounds[0].matches.forEach(m => {
          if(m.p2.isBye) m.winnerId = m.p1.id;
          else if(m.p1.isBye) m.winnerId = m.p2.id;
      });

      saveToCloud(); refreshAllUI(); switchTab(2);
  }

  /* --- Battle --- */
  function createBattlePanelsHtml() {
      const c=document.getElementById('battlePanels'); c.innerHTML='';
      ROUND_CONFIG.forEach(cfg=>{ c.innerHTML+=`<div id="panel${cfg.tabId}" class="panel"><div class="status-bar"><h3 style="color:#fff;">${cfg.cn} ${cfg.en}</h3><div><button class="btn btn-green" id="btnNext${cfg.idx}" onclick="nextRound(${cfg.idx})">NEXT >></button></div></div><div class="battle-container" id="matchesContainer${cfg.idx}"></div></div>`; });
  }
  function refreshBattlePanels() {
      appData.rounds.forEach((rnd,idx)=>{
          if(!rnd)return;
          const c=document.getElementById(`matchesContainer${idx}`); c.innerHTML='';
          const fin=rnd.matches.every(m=>m.winnerId);
          rnd.matches.forEach(m=>{
              const p1W=m.winnerId===m.p1.id, p2W=m.winnerId===m.p2.id;
              const lk=appData.rounds[idx+1]?true:false;
              // ÁÇπÂáªËÉúË¥üÈÄªËæë
              const c1=lk?'':`onclick="setWin(${idx},${m.id-1},'${m.p1.id}')"`, c2=lk?'':`onclick="setWin(${idx},${m.id-1},'${m.p2.id}')"`;
              
              const av1 = m.p1.avatar || DEFAULT_AVATAR;
              const av2 = m.p2.avatar || DEFAULT_AVATAR;

              c.innerHTML+=`
              <div class="match-card">
                <div class="match-header">MATCH ${m.id}</div>
                <div class="match-tools">
                    <button class="btn-small btn-purple" onclick="openVSScreen('${m.p1.name}','${m.p1.id}','${av1}','${m.p2.name}','${m.p2.id}','${av2}')">üì∫ VS SCREEN</button>
                </div>
                <div class="fighter ${p1W?'winner':(m.winnerId?'loser':'')}" ${c1}>
                    <img src="${av1}" class="avatar-medium">
                    <span class="fighter-name">${m.p1.name}</span>
                    <span class="fighter-id">#${m.p1.id}</span>
                </div>
                <div class="vs-icon">VS</div>
                <div class="fighter ${p2W?'winner':(m.winnerId?'loser':'')}" ${c2}>
                    <img src="${av2}" class="avatar-medium">
                    <span class="fighter-name">${m.p2.name}</span>
                    <span class="fighter-id">#${m.p2.id}</span>
                </div>
              </div>`;
          });
          const btn=document.getElementById(`btnNext${idx}`);
          if(btn){ if(appData.rounds[idx+1]){btn.innerHTML='DONE';btn.disabled=true;btn.style.background='#333';}else{btn.innerHTML='GENERATE NEXT';btn.disabled=!fin;btn.style.background=fin?'var(--spray-lime)':'#333';} }
      });
  }
  function setWin(r,m,w){ appData.rounds[r].matches[m].winnerId=(appData.rounds[r].matches[m].winnerId===w)?null:w; saveToCloud(); refreshBattlePanels(); }
  function nextRound(c){
      if(!confirm('Next Round?'))return;
      const cur=appData.rounds[c].matches, next=[];
      for(let i=0;i<cur.length;i+=2) next.push({id:(i/2)+1, p1:getId(cur[i]), p2:getId(cur[i+1]), winnerId:null});
      appData.rounds[c+1]={matches:next}; 
      // Ëá™Âä®Âà§ÂÆö‰∏ã‰∏ÄËΩÆÁöÑ BYE
      appData.rounds[c+1].matches.forEach(m => {
          if(m.p2.isBye) m.winnerId = m.p1.id;
          else if(m.p1.isBye) m.winnerId = m.p2.id;
      });
      saveToCloud(); refreshAllUI(); switchTab(c+3);
  }
  function getId(m){return m.winnerId===m.p1.id?m.p1:m.p2;}

  /* --- Â§ßÂ±èÂ±ïÁ§∫ÈÄªËæë --- */
  function openVSScreen(n1, i1, a1, n2, i2, a2) {
      document.getElementById('vsName1').innerText = n1;
      document.getElementById('vsId1').innerText = i1;
      document.getElementById('vsAvatar1').src = a1;
      
      document.getElementById('vsName2').innerText = n2;
      document.getElementById('vsId2').innerText = i2;
      document.getElementById('vsAvatar2').src = a2;
      
      document.getElementById('vsScreen').style.display = 'flex';
  }

  function switchTab(n) { document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('active',i===n)); document.querySelectorAll('.panel').forEach((p,i)=>p.classList.toggle('active',i===n)); }
  function clearAll() { if(confirm('RESET ALL?')) { appData={players:[],audition:{finished:false,results:[]},judgeCount:3,rounds:[]}; saveToCloud(); refreshAllUI(); } }
  function showQR() { const u=prompt("Register URL:",window.location.href.replace('admin_qr.html','register.html')); if(u){document.getElementById('qrcode').innerHTML="";new QRCode(document.getElementById('qrcode'),{text:u,width:256,height:256});document.getElementById('qrModal').style.display='flex';} }
  function exportAuditionPDF(){ /* ‰øùÊåÅÂéüÊúâPDFÈÄªËæë */ }
</script>
</body>
</html>

