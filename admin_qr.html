<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>STREET WARS 2025 - ADMIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- å½©å¸¦ç‰¹æ•ˆ -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<!-- å­—ä½“ -->
<link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Permanent+Marker&family=Rubik+Glitch&display=swap" rel="stylesheet">
<!-- äºŒç»´ç  -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  :root { --cyan:#00f7ff; --pink:#ff0099; --lime:#ccff00; --yellow:#ffee00; --bg:#0f0f0f; }
  body {
    background: var(--bg) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill-opacity="0.05"><path d="M0 60 L60 0 H30 L0 30 Z" fill="white"/></svg>');
    color:#eee; font-family:"Microsoft YaHei",sans-serif; margin:0; padding:20px; overflow-x:hidden;
  }
  .container { max-width:1300px; margin:0 auto; background:rgba(20,20,20,0.95); border:4px solid #fff; box-shadow:10px 10px 0 #000; padding:10px; min-height:800px; }
  header { text-align:center; padding:30px; border-bottom:3px dashed var(--pink);}
  h1 { font-family:'Rubik Glitch',cursive; font-size:50px; margin:0; text-shadow:4px 4px 0 var(--pink);}
  header p { margin:5px 0 0; font-family:'Black Ops One'; color:var(--yellow); }

  .tabs { display:flex; justify-content:center; gap:15px; padding:20px; border-bottom:5px solid var(--cyan);}
  .tab { font-family:'Black Ops One'; font-size:16px; padding:8px 15px; cursor:pointer; background:#222; border:2px solid #555; transform:skewX(-15deg); transition:0.2s;}
  .tab.active { background:var(--cyan); color:#000; border-color:#fff; box-shadow:0 0 15px var(--cyan); transform:skewX(-15deg) scale(1.1);}
  .panel { display:none; padding:30px;}
  .panel.active { display:block; animation:fadeIn 0.3s;}
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }

  .btn { font-family:'Black Ops One'; border:none; padding:8px 20px; margin:5px; cursor:pointer; transform:skewX(-10deg); transition:0.2s;}
  .btn:hover { transform:skewX(-10deg) translate(-2px,-2px); box-shadow:4px 4px 0 #000;}
  .btn-green { background:var(--lime); color:#000;}
  .btn-blue { background:var(--cyan); color:#000;}
  .btn-pink { background:var(--pink); color:#fff;}
  .btn-dark { background:#333; color:#fff;}
  .btn-small{padding:4px 10px;font-size:12px;}

  input { background:transparent; border:1px solid #555; color:#fff; padding:5px; text-align:center; font-family:'Black Ops One'; font-size:16px;}
  .status-bar { background:#000; border:2px solid #444; padding:10px; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;}

  table { width:100%; border-collapse:separate; border-spacing:0 6px;}
  th { color:#888; font-size:14px; border-bottom:2px solid #333; padding:6px;}
  td { background:#111; padding:6px; border-top:1px solid #222; border-bottom:1px solid #222; text-align:center; vertical-align:middle;}
  .avatar-sm { width:40px; height:40px; border-radius:50%; border:2px solid #fff; object-fit:cover;}

  .top-rank td { border-top:1px dashed var(--cyan); border-bottom:1px dashed var(--cyan); background:rgba(0,247,255,0.05);}
  .rank-num { font-family:'Rubik Glitch'; font-size:20px; color:#777;}
  .top-rank .rank-num { color:var(--cyan); text-shadow:0 0 2px rgba(0,247,255,0.7);}

  .battle-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(420px,1fr));gap:20px;margin-top:20px;}
  .match-card{position:relative;background:#000;border:2px solid #fff;display:flex;align-items:center;justify-content:space-between;padding:10px;box-shadow:5px 5px 0 #000;}
  .match-tools{position:absolute;top:5px;right:5px;}
  .fighter{flex:1;text-align:center;padding:10px;cursor:pointer;transition:0.2s;display:flex;flex-direction:column;align-items:center;border:1px solid transparent;}
  .fighter:hover{border-color:#555;}
  .fighter img{width:60px;height:60px;border-radius:50%;border:2px solid #fff;object-fit:cover;margin-bottom:5px;}
  .fighter.winner{background:var(--cyan);color:#000 !important;box-shadow:0 0 15px var(--cyan);transform:scale(1.05);}
  .fighter.loser{opacity:0.3;filter:grayscale(1);}
  .vs-tag{font-family:'Rubik Glitch';font-size:32px;color:var(--pink);margin:0 10px;}

  /* å¼¹çª—é»˜è®¤éšè— */
  #vsScreen,#ceremonyScreen,#qrModal{display:none;position:fixed;inset:0;z-index:9999;}

  #vsScreen{background:#000;display:flex;flex-direction:row;align-items:center;justify-content:center;}
  .vs-side{flex:1;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;}
  .vs-side.left{background:linear-gradient(135deg,#111,#000);border-right:5px solid var(--cyan);}
  .vs-side.right{background:linear-gradient(225deg,#111,#000);border-left:5px solid var(--pink);}
  .vs-avatar-big{width:300px;height:300px;border-radius:50%;border:10px solid #fff;object-fit:cover;margin-bottom:20px;}
  .vs-name-big{font-family:'Rubik Glitch';font-size:60px;color:#fff;}
  .vs-id-big{font-family:'Black Ops One';font-size:32px;color:var(--yellow);background:#000;padding:4px 16px;margin-top:10px;}
  .vs-center-logo{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-family:'Rubik Glitch';font-size:140px;color:#fff;text-shadow:0 0 30px var(--pink);pointer-events:none;}
  .close-btn{position:absolute;top:20px;right:20px;font-size:30px;color:#fff;cursor:pointer;opacity:0.6;z-index:10000;}

  #ceremonyScreen{background:#000;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:40px;}
  .ceremony-bg{position:absolute;inset:0;background:radial-gradient(circle at 50% 20%,rgba(255,255,255,0.1) 0,#000 60%);z-index:-1;}
  .ceremony-title{position:absolute;top:40px;font-family:'Rubik Glitch';font-size:72px;color:#fff;}
  .podium{display:flex;align-items:flex-end;gap:40px;}
  .rank-col{display:flex;flex-direction:column;align-items:center;}
  .avatar-box{width:180px;height:180px;border-radius:50%;border:8px solid #fff;overflow:hidden;margin-bottom:-40px;background:#000;}
  .avatar-box img{width:100%;height:100%;object-fit:cover;}
  .rank-col.first .avatar-box{width:260px;height:260px;border-color:var(--yellow);box-shadow:0 0 50px var(--yellow);}
  .info-box{background:#111;border:3px solid #fff;padding:50px 20px 20px;width:220px;clip-path:polygon(0 20%,100% 0,100% 100%,0 100%);text-align:center;}
  .rank-col.first .info-box{width:300px;padding-top:80px;background:linear-gradient(180deg,#ffd700,#b8860b);}
  #qrModal{background:rgba(0,0,0,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;}
  #qrcode{background:#fff;padding:20px;border:4px solid var(--lime);}
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>STREET WARS 2025</h1>
    <p>è¡—èˆå·…å³°äº‰éœ¸èµ› Â· ç®¡ç†ç«¯</p>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="switchTab(0)">é€‰æ‰‹åº“</div>
    <div class="tab" onclick="switchTab(1)">æµ·é€‰</div>
    <div class="tab" onclick="switchTab(2)">32å¼º</div>
    <div class="tab" onclick="switchTab(3)">16å¼º</div>
    <div class="tab" onclick="switchTab(4)">8å¼º</div>
    <div class="tab" onclick="switchTab(5)">åŠå†³èµ›</div>
    <div class="tab" onclick="switchTab(6)">å†³èµ›</div>
  </div>

  <!-- é€‰æ‰‹åº“ -->
  <div class="panel active" id="panel0">
    <div class="status-bar">
      <div>
        <input id="searchPlayer" style="background:transparent;border:none;border-bottom:2px solid var(--cyan);width:200px;" placeholder="æœç´¢å§“åæˆ–å·ç ..." oninput="renderPlayerManager()">
        <span style="margin-left:10px;">æ€»äººæ•°: <b id="totalCount">0</b></span>
      </div>
      <div>
        <button class="btn btn-green" onclick="syncRegistration()">æ¥æ”¶æŠ¥å</button>
        <button class="btn btn-blue" onclick="showQR()">äºŒç»´ç </button>
        <button class="btn btn-pink" onclick="addPlayer()">æ‰‹åŠ¨æ·»åŠ </button>
        <button class="btn btn-dark" onclick="resetGameOnly()">é‡ç½®æ¯”èµ›(ä¿ç•™é€‰æ‰‹)</button>
      </div>
    </div>
    <table>
      <thead><tr><th>å¤´åƒ</th><th>å·ç </th><th>å§“å</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="playerListBody"></tbody>
    </table>
  </div>

  <!-- æµ·é€‰ -->
  <div class="panel" id="panel1">
    <div class="status-bar">
      <div>è£åˆ¤æ•°ï¼š<input type="number" id="judgeCount" value="3" min="1" max="5" style="width:50px" onchange="renderScoreTable(true)"></div>
      <div>
        <button class="btn btn-blue" onclick="renderScoreTable(true)">åˆ·æ–°æ’å</button>
        <button class="btn btn-pink" onclick="exportAuditionPDF()">å¯¼å‡ºæˆç»©å•(PDF)</button>
        <button class="btn btn-green" onclick="finalizeAudition()">é”å®šå¹¶æ™‹çº§ >></button>
      </div>
    </div>
    <p style="color:#666;font-size:12px;">å‰32åæ™‹çº§ï¼›ä¸è¶³32äººè‡ªåŠ¨å¡«å…… BYEã€‚</p>
    <table>
      <thead><tr id="scoreHeader"></tr></thead>
      <tbody id="scoreBody"></tbody>
    </table>
  </div>

  <!-- å¯¹æˆ˜è½®æ¬¡ -->
  <div id="battlePanels"></div>
</div>

<!-- VS å¤§å± -->
<div id="vsScreen">
  <div class="vs-side left">
    <img id="vsAvatar1" class="vs-avatar-big">
    <div id="vsName1" class="vs-name-big"></div>
    <div id="vsId1" class="vs-id-big"></div>
  </div>
  <div class="vs-center-logo">VS</div>
  <div class="vs-side right">
    <img id="vsAvatar2" class="vs-avatar-big">
    <div id="vsName2" class="vs-name-big"></div>
    <div id="vsId2" class="vs-id-big"></div>
  </div>
  <div class="close-btn" onclick="document.getElementById('vsScreen').style.display='none'">Ã—</div>
</div>

<!-- é¢å¥–å¤§å± -->
<div id="ceremonyScreen">
  <div class="ceremony-bg"></div>
  <div class="ceremony-title">THE CHAMPIONS</div>
  <div class="close-btn" onclick="document.getElementById('ceremonyScreen').style.display='none'">Ã—</div>
  <div class="podium" id="podiumContent"></div>
</div>

<!-- æŠ¥åäºŒç»´ç  -->
<div id="qrModal">
  <div id="qrcode"></div>
  <p style="color:#fff;margin-top:20px;">SCAN TO REGISTER</p>
  <div class="close-btn" onclick="document.getElementById('qrModal').style.display='none'">Ã—</div>
</div>

<script>
// ===== Supabase é…ç½® =====
const SB_URL = "https://htqlaedczmaezrlqmwft.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0cWxhZWRjem1hZXpybHFtd2Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTQ2NzEsImV4cCI6MjA4NTkzMDY3MX0._LB75XfBc940vgnmx95ryZxWb-AZRJmuty8B1z_x08g";
const { createClient } = supabase;
const sb = (SB_URL.startsWith('http')) ? createClient(SB_URL, SB_KEY) : null;

const DEFAULT_AVATAR =
  'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjMzMzIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIvPjwvc3ZnPg==';

let appData = {
  players: [],
  audition: { finished:false, results:[] },
  judgeCount: 3,
  rounds: []
};

const ROUND_CONFIG = [
  {idx:0, tabId:2, name:'32 å¼º (TOP 32)'},
  {idx:1, tabId:3, name:'16 å¼º (TOP 16)'},
  {idx:2, tabId:4, name:'8 å¼º (TOP 8)'},
  {idx:3, tabId:5, name:'åŠå†³èµ› (SEMI)'},
  {idx:4, tabId:6, name:'å†³èµ› (FINAL)'}
];

window.onload = async () => {
  if(sb) await loadFromCloud();
  ensureData();
  createBattlePanels();
  refreshUI();   // âœ… åˆå§‹åŒ–æ—¶åŒæ­¥é€‰æ‰‹â†’æµ·é€‰
  if(sb){
    sb.channel('reg-ch')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'registrations'},()=>syncRegistration())
      .subscribe();
  }
};

function ensureData(){
  if(!appData.players) appData.players=[];
  if(!appData.audition) appData.audition={finished:false,results:[]};
  if(!Array.isArray(appData.audition.results)) appData.audition.results=[];
  if(!Array.isArray(appData.rounds)) appData.rounds=[];
}

/* ---------- Supabase ---------- */
async function loadFromCloud(){
  try{
    const {data} = await sb.from('game_state').select('data').eq('id',1).maybeSingle();
    if(data?.data) appData = data.data;
  }catch(e){console.error(e);}
}
async function saveToCloud(){ if(sb) await sb.from('game_state').upsert({id:1,data:appData}); }

async function syncRegistration(){
  if(!sb){alert('æœªé…ç½® Supabase');return;}
  const {data} = await sb.from('registrations').select('*').eq('processed',false);
  if(data && data.length){
    data.forEach(r=>{
      if(!appData.players.some(p=>p.id===r.player_id)){
        appData.players.push({id:r.player_id,name:r.player_name,avatar:r.avatar||DEFAULT_AVATAR});
      }
    });
    await sb.from('registrations').update({processed:true}).in('id',data.map(r=>r.id));
    alert(`å·²åŒæ­¥ ${data.length} ä½æ–°é€‰æ‰‹`);
    saveToCloud();
    refreshUI();
  }else{
    alert('æš‚æ— æ–°æŠ¥å');
  }
}

/* ---------- UI æ€»åˆ·æ–° ---------- */
function refreshUI(){
  renderPlayerManager();
  if(!appData.audition.finished) syncAuditionList();
  renderScoreTable(false);
  refreshBattlePanels();
}

/* ---------- Tab åˆ‡æ¢ ---------- */
function switchTab(i){
  document.querySelectorAll('.tab').forEach((t,idx)=>t.classList.toggle('active',idx===i));
  document.querySelectorAll('.panel').forEach((p,idx)=>p.classList.toggle('active',idx===i));
}

/* ---------- é€‰æ‰‹åº“ ---------- */
function addPlayer(){
  appData.players.push({id:'',name:'',avatar:DEFAULT_AVATAR});
  refreshUI(); 
  saveToCloud();
}

function renderPlayerManager(){
  const term=document.getElementById('searchPlayer').value.toLowerCase()||'';
  const tb=document.getElementById('playerListBody'); tb.innerHTML='';
  appData.players.forEach((p,i)=>{
    if(term && !p.id.toLowerCase().includes(term) && !p.name.toLowerCase().includes(term)) return;
    tb.innerHTML += `
      <tr>
        <td><img src="${p.avatar||DEFAULT_AVATAR}" class="avatar-sm"></td>
        <td><input value="${p.id}" oninput="appData.players[${i}].id=this.value; saveToCloud()"></td>
        <td><input style="text-align:left;" value="${p.name}" oninput="appData.players[${i}].name=this.value; saveToCloud()"></td>
        <td><button class="btn-small btn-dark" onclick="removePlayer(${i})">åˆ </button></td>
      </tr>`;
  });
  document.getElementById('totalCount').innerText = appData.players.length;
}

function removePlayer(i){
  if(!confirm('ç¡®å®šåˆ é™¤è¯¥é€‰æ‰‹ï¼Ÿ'))return;
  appData.players.splice(i,1);
  refreshUI();
  saveToCloud();
}

// ä»…é‡ç½®æ¯”èµ›æ•°æ®ï¼Œä¿ç•™é€‰æ‰‹
function resetGameOnly(){
  if(!confirm("é‡ç½®æ¯”èµ›ï¼ˆä¿ç•™é€‰æ‰‹ï¼‰ï¼Ÿ\nè¿™ä¼šæ¸…ç©ºæµ·é€‰å’Œæ‰€æœ‰è½®æ¬¡ã€‚")) return;
  appData.audition={finished:false,results:[]};
  appData.rounds=[];
  refreshUI();
  saveToCloud();
}

/* ---------- æµ·é€‰é€»è¾‘ ---------- */
function syncAuditionList(){
  if(appData.audition.finished) return;
  const map={}; appData.audition.results.forEach(r=>map[r.id]=r.scores||[]);
  appData.audition.results = appData.players.map(p=>({
    id:p.id,
    name:p.name,
    avatar:p.avatar||DEFAULT_AVATAR,
    scores: map[p.id]||[],
    avg:0,
    rank:0
  }));
}

function renderScoreTable(sort){
  ensureData();
  const judges=parseInt(document.getElementById('judgeCount').value)||3;
  appData.judgeCount=judges;

  // ğŸŒŸ æ¯æ¬¡åˆ·æ–°æ’åå‰ï¼Œå¦‚æœè¿˜æ²¡é”å®šï¼Œå°±å†åŒæ­¥ä¸€æ¬¡åå•
  if(!appData.audition.finished) syncAuditionList();

  document.getElementById('scoreHeader').innerHTML=
    `<th>å¤´åƒ</th><th>æ’å</th><th>å·ç </th><th>å§“å</th><th>å¹³å‡åˆ†</th>`+
    Array(judges).fill(0).map((_,i)=>`<th>J${i+1}</th>`).join('');

  appData.audition.results.forEach(p=>{
    let s=0,c=0;
    for(let i=0;i<judges;i++){
      const v=parseFloat(p.scores[i]); if(!isNaN(v)){s+=v;c++;}
    }
    p.avg=c?s/c:0;
  });

  if(sort || appData.audition.finished){
    appData.audition.results.sort((a,b)=>b.avg-a.avg || a.id.localeCompare(b.id));
    appData.audition.results.forEach((p,i)=>p.rank=i+1);
  }

  const tb=document.getElementById('scoreBody'); tb.innerHTML='';
  appData.audition.results.forEach(p=>{
    const top=p.rank<=32;
    tb.innerHTML += `
      <tr ${top?'class="top-rank"':''}>
        <td><img src="${p.avatar||DEFAULT_AVATAR}" class="avatar-sm"></td>
        <td class="rank-num">${p.rank||'-'}</td>
        <td>${p.id}</td>
        <td style="text-align:left;">${p.name}</td>
        <td style="color:${top?'var(--cyan)':'var(--pink)'}">${p.avg.toFixed(2)}</td>
        ${Array(judges).fill(0).map((_,j)=>`
          <td>
            <input type="number" step="0.1"
              value="${p.scores[j]||''}"
              ${appData.audition.finished?'disabled':''}
              oninput="scoreIn('${p.id}',${j},this.value)">
          </td>`).join('')}
      </tr>`;
  });
}

function scoreIn(id,idx,val){
  const p=appData.audition.results.find(x=>x.id===id);
  if(p){
    if(!Array.isArray(p.scores)) p.scores=[];
    p.scores[idx]=val;
    saveToCloud();
  }
}

// å¯¼å‡ºæµ·é€‰ PDF
function exportAuditionPDF(){
  const judges=appData.judgeCount;
  let list=[...appData.audition.results].sort((a,b)=>b.avg-a.avg||a.id.localeCompare(b.id));
  const rows=list.map((p,i)=>{
    const rank=i+1, top=rank<=32;
    const bg=top?'background-color:#d1fae5;font-weight:bold;':'';
    const status=top?'âœ… æ™‹çº§ / PROMOTED':'';
    const scoreCells=Array(judges).fill(0).map((_,j)=>`<td style="border:1px solid #ccc;padding:4px;">${p.scores[j]||'-'}</td>`).join('');
    return `<tr style="${bg}"><td style="border:1px solid #ccc;padding:4px;">${rank}</td><td style="border:1px solid #ccc;padding:4px;">${p.id}</td><td style="border:1px solid #ccc;padding:4px;text-align:left;">${p.name}</td>${scoreCells}<td style="border:1px solid #ccc;padding:4px;">${p.avg.toFixed(2)}</td><td style="border:1px solid #ccc;padding:4px;">${status}</td></tr>`;
  }).join('');
  const html=`<html><head><meta charset="UTF-8"><title>æµ·é€‰æˆç»©å•</title></head><body style="font-family:Microsoft YaHei,Arial;padding:20px;">
      <h1 style="text-align:center;">STREET WARS 2025 æµ·é€‰æˆç»©å•</h1>
      <table style="width:100%;border-collapse:collapse;text-align:center;font-size:12px;">
        <tr style="background:#eee;">
          <th style="border:1px solid #ccc;padding:6px;">æ’å</th>
          <th style="border:1px solid #ccc;padding:6px;">å·ç </th>
          <th style="border:1px solid #ccc;padding:6px;">å§“å</th>
          <th colspan="${judges}" style="border:1px solid #ccc;padding:6px;">è£åˆ¤æ‰“åˆ†</th>
          <th style="border:1px solid #ccc;padding:6px;">å¹³å‡åˆ†</th>
          <th style="border:1px solid #ccc;padding:6px;">æ™‹çº§</th>
        </tr>
        ${rows}
      </table>
    </body></html>`;
  const win=window.open('','_blank'); win.document.write(html); win.document.close(); setTimeout(()=>win.print(),500);
}

// ç”Ÿæˆ 32 å¼º
function finalizeAudition(){
  if(appData.audition.finished){alert('æµ·é€‰å·²é”å®š');return;}
  renderScoreTable(true);
  let top32=appData.audition.results.slice(0,32);
  if(top32.length<32){
    if(!confirm(`å½“å‰ ${top32.length} äººï¼Œè‡ªåŠ¨è¡¥ BYE åˆ° 32ï¼Ÿ`))return;
    const need=32-top32.length;
    for(let i=0;i<need;i++) top32.push({id:'BYE',name:'BYE',avatar:DEFAULT_AVATAR,isBye:true,scores:[],avg:0});
  }
  appData.audition.finished=true;
  appData.audition.results=top32;

  const seed=[[1,32],[16,17],[9,24],[8,25],[5,28],[12,21],[13,20],[4,29],[3,30],[14,19],[11,22],[6,27],[7,26],[10,23],[15,18],[2,31]];
  appData.rounds[0]={matches:seed.map((p,i)=>({id:i+1,p1:top32[p[0]-1],p2:top32[p[1]-1],winnerId:null}))};
  autoSetByeWinners(0);
  saveToCloud();
  refreshUI();
  switchTab(2);
}

/* ---------- å¯¹æˆ˜æ™‹çº§é€»è¾‘ï¼ˆé‡ç‚¹ä¿®å¤ï¼‰ ---------- */

// è§£ææŸåœºæ¯”èµ›çš„èƒœè€…ï¼ˆåŒ…æ‹¬ BYE è‡ªåŠ¨èƒœå‡ºï¼‰ï¼Œä¸ä¿®æ”¹åŸæ•°æ®
function resolveWinner(m){
  if(!m) return null;
  const p1 = m.p1 || {};
  const p2 = m.p2 || {};
  if(m.winnerId){
    if(m.winnerId===p1.id) return p1;
    if(m.winnerId===p2.id) return p2;
  }
  // è‡ªåŠ¨ BYE è§„åˆ™
  if(p1.isBye && !p2.isBye) return p2;
  if(p2.isBye && !p1.isBye) return p1;
  if(p1.isBye && p2.isBye) return p1; // ä¸¤ä¸ªBYEéšä¾¿
  return null;
}

// è‡ªåŠ¨ä¸ºåŒ…å« BYE çš„åœºæ¬¡å¡«å…… winnerId
function autoSetByeWinners(roundIdx){
  const round=appData.rounds[roundIdx];
  if(!round||!round.matches) return;
  round.matches.forEach(m=>{
    if(m.winnerId) return;
    const w = resolveWinner(m);
    if(w) m.winnerId = w.id;
  });
}

/* --- Battle UI --- */
function createBattlePanels(){
  document.getElementById('battlePanels').innerHTML = ROUND_CONFIG.map(cfg=>`
    <div class="panel" id="panel${cfg.tabId}">
      <div class="status-bar">
        <div>${cfg.name}</div>
        <div>
          <button class="btn btn-green" id="nextBtn${cfg.idx}" onclick="nextRound(${cfg.idx})">ä¸‹ä¸€è½®</button>
          ${cfg.idx===4?'<button class="btn btn-pink" onclick="showCeremony()">ğŸ† é¢å¥–</button>':''}
        </div>
      </div>
      <div class="battle-container" id="box${cfg.idx}"></div>
    </div>`).join('');
}

function refreshBattlePanels(){
  ensureData();
  ROUND_CONFIG.forEach(cfg=>{
    const idx=cfg.idx, round=appData.rounds[idx], box=document.getElementById('box'+idx), btn=document.getElementById('nextBtn'+idx);
    if(!box) return;
    box.innerHTML='';
    if(!round||!round.matches){
      if(btn){btn.disabled=true;btn.textContent='ç­‰å¾…ä¸Šä¸€è½®';}
      return;
    }
    // è¿™ä¸€è½®æ˜¯å¦æ‰€æœ‰å¯¹å±€éƒ½æœ‰èƒœè€…ï¼ˆå« BYE è‡ªåŠ¨èƒœå‡ºï¼‰
    const done = round.matches.every(m=>resolveWinner(m)!==null);
    if(btn){
      btn.disabled = !done || idx===4;  // å†³èµ›æœ€åä¸€è½®æ²¡æœ‰ä¸‹ä¸€è½®
      if(idx===4) btn.style.display='none';
    }

    round.matches.forEach((m,i)=>{
      const p1=m.p1||{}, p2=m.p2||{};
      const w1 = m.winnerId===p1.id;
      const w2 = m.winnerId===p2.id;
      const locked = !!appData.rounds[idx+1]; // å·²ç»æœ‰ä¸‹ä¸€è½®åˆ™é”å®šæœ¬è½®
      const c1 = locked?'':`onclick="setWinner(${idx},${i},'${p1.id}')"`;
      const c2 = locked?'':`onclick="setWinner(${idx},${i},'${p2.id}')"`;

      box.innerHTML += `
        <div class="match-card">
          <div class="match-tools">
            <button class="btn-small btn-dark" onclick="openVS('${escape(p1.name||"")}','${p1.id||""}','${p1.avatar||DEFAULT_AVATAR}','${escape(p2.name||"")}','${p2.id||""}','${p2.avatar||DEFAULT_AVATAR}')">VS</button>
          </div>
          <div class="fighter ${w1?'winner':(m.winnerId?'loser':'')}" ${c1}>
            <img src="${p1.avatar||DEFAULT_AVATAR}">
            <div>${p1.name||''}</div>
          </div>
          <div class="vs-tag">VS</div>
          <div class="fighter ${w2?'winner':(m.winnerId?'loser':'')}" ${c2}>
            <img src="${p2.avatar||DEFAULT_AVATAR}">
            <div>${p2.name||''}</div>
          </div>
        </div>`;
    });
  });
}

function setWinner(roundIdx, matchIdx, pid){
  const round = appData.rounds[roundIdx];
  if(!round) return;
  const m = round.matches[matchIdx];
  if(!m) return;
  m.winnerId = (m.winnerId===pid ? null : pid);  // å…è®¸ç‚¹åŒä¸€æ–¹å–æ¶ˆ
  saveToCloud();
  refreshBattlePanels();
}

// ä¸‹ä¸€è½®ç”Ÿæˆé€»è¾‘ï¼ˆä¿®å¤ç‰ˆï¼‰
function nextRound(roundIdx){
  if(roundIdx===4) return; // å†³èµ›æœ€åä¸€è½®æ— ä¸‹ä¸€è½®
  const round = appData.rounds[roundIdx];
  if(!round || !round.matches || !round.matches.length){
    alert('æœ¬è½®æ²¡æœ‰å¯¹é˜µ');
    return;
  }

  // æ”¶é›†æ‰€æœ‰èƒœè€…ï¼ˆåŒ…æ‹¬ BYE è‡ªåŠ¨èƒœå‡ºï¼‰
  const winners = [];
  for(const m of round.matches){
    const w = resolveWinner(m);
    if(!w){
      alert('è¿˜æœ‰å¯¹å±€æœªé€‰å‡ºèƒœè€…');
      return;
    }
    winners.push(w);
  }
  if(winners.length < 2){
    alert('èƒœè€…æ•°é‡ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆä¸‹ä¸€è½®');
    return;
  }

  if(!confirm('æ ¹æ®æœ¬è½®ç»“æœç”Ÿæˆä¸‹ä¸€è½®ï¼Ÿ')) return;

  const nextMatches = [];
  for(let i=0;i<winners.length;i+=2){
    const p1 = winners[i];
    const p2 = winners[i+1] || {id:'BYE',name:'BYE',avatar:DEFAULT_AVATAR,isBye:true};
    nextMatches.push({id:nextMatches.length+1,p1,p2,winnerId:null});
  }
  appData.rounds[roundIdx+1] = { matches: nextMatches };
  autoSetByeWinners(roundIdx+1);  // è‡ªåŠ¨è®¾ç½®æ–°ä¸€è½®çš„ BYE èƒœè€…

  saveToCloud();
  refreshBattlePanels();
  switchTab(roundIdx+3);  // åˆ‡æ¢åˆ°å¯¹åº”æ ‡ç­¾ï¼ˆ32->16->8->4->2ï¼‰
}

/* ---------- VS å±å¹• ---------- */
function openVS(n1,id1,av1,n2,id2,av2){
  document.getElementById('vsName1').innerText=unescape(n1); document.getElementById('vsId1').innerText='#'+id1; document.getElementById('vsAvatar1').src=av1||DEFAULT_AVATAR;
  document.getElementById('vsName2').innerText=unescape(n2); document.getElementById('vsId2').innerText='#'+id2; document.getElementById('vsAvatar2').src=av2||DEFAULT_AVATAR;
  document.getElementById('vsScreen').style.display='flex';
}

/* ---------- é¢å¥–å¤§å± ---------- */
function showCeremony(){
  const fr = appData.rounds[4];
  if(!fr || !fr.matches || !fr.matches[0] || !fr.matches[0].winnerId){
    alert('å†³èµ›è¿˜æœªå®Œæˆã€‚');
    return;
  }
  const m = fr.matches[0];
  const champ = resolveWinner(m);
  const runner = (champ && champ.id===m.p1.id) ? m.p2 : m.p1;

  const sr = appData.rounds[3];
  const thirds = [];
  if(sr && sr.matches){
    sr.matches.forEach(sm=>{
      const w = resolveWinner(sm);
      if(!w) return;
      const loser = (w.id===sm.p1.id)? sm.p2 : sm.p1;
      if(loser && loser.id!=='BYE') thirds.push(loser);
    });
  }

  const box=document.getElementById('podiumContent'); box.innerHTML='';
  if(runner) box.innerHTML+=podiumBlock(runner,'second','2ND');
  if(champ)  box.innerHTML+=podiumBlock(champ,'first','WINNER');
  thirds.forEach(t=> box.innerHTML+=podiumBlock(t,'third','3RD'));

  document.getElementById('ceremonyScreen').style.display='flex';
  confetti({particleCount:200,spread:120,origin:{y:0.6}});
}

function podiumBlock(p,cls,label){
  if(!p) return '';
  return `<div class="rank-col ${cls}">
      ${cls==='first'?'<div class="crown">ğŸ‘‘</div>':''}
      <div class="avatar-box"><img src="${p.avatar||DEFAULT_AVATAR}"></div>
      <div class="info-box">
        <div style="font-family:'Permanent Marker';font-size:30px;">${p.name}</div>
        <div style="font-family:'Black Ops One';margin-top:8px;">#${p.id}</div>
        <div style="margin-top:8px;font-family:'Rubik Glitch';font-size:28px;">${label}</div>
      </div>
    </div>`;
}

/* ---------- æŠ¥åäºŒç»´ç  ---------- */
function showQR(){
  const u = prompt('è¯·è¾“å…¥æŠ¥åé¡µ register.html çš„ç½‘å€ï¼š', window.location.href.replace('admin_qr.html','register.html'));
  if(!u) return;
  document.getElementById('qrcode').innerHTML="";
  new QRCode(document.getElementById('qrcode'),{text:u,width:256,height:256});
  document.getElementById('qrModal').style.display='flex';
}
</script>
</body>
</html>
